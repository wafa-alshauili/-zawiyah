<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار نظام منع التعارضات</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
        }
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .demo-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        .conflict-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .device-simulator {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff9a9e;
            position: relative;
        }
        .device-header {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }
        .status-offline { background: #dc3545; }
        .status-syncing { background: #ffc107; animation: pulse 1s infinite; }
        .booking-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ff9a9e;
            font-size: 12px;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        button {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .conflict-alert {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .success-alert {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .stats-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #fad0c4;
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
        }
        .timeline {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .timeline-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .timeline-time {
            color: #666;
            font-weight: bold;
            display: inline-block;
            width: 80px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>🛡️ اختبار نظام منع التعارضات</h1>
            <p>محاكاة متعددة الأجهزة لضمان عدم حدوث تعارضات في الحجوزات</p>
        </div>

        <!-- إحصائيات النظام -->
        <div class="stats-panel">
            <h2>📊 إحصائيات النظام المباشرة</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="active-locks">0</div>
                    <div class="stat-label">أقفال نشطة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="prevented-conflicts">0</div>
                    <div class="stat-label">تعارضات منعت</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successful-bookings">0</div>
                    <div class="stat-label">حجوزات ناجحة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sync-speed">0ms</div>
                    <div class="stat-label">سرعة المزامنة</div>
                </div>
            </div>
        </div>

        <!-- محاكاة الأجهزة المتعددة -->
        <div class="demo-section">
            <h2>📱 محاكاة الأجهزة المتعددة</h2>
            <div class="conflict-demo">
                <!-- الجهاز الأول -->
                <div class="device-simulator">
                    <div class="status-indicator" id="device1-status"></div>
                    <div class="device-header">📱 جهاز الأستاذ أحمد</div>
                    
                    <div class="booking-form">
                        <div class="form-group">
                            <label>المادة:</label>
                            <select id="device1-subject">
                                <option value="الرياضيات">الرياضيات</option>
                                <option value="العلوم">العلوم</option>
                                <option value="اللغة العربية">اللغة العربية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>القاعة:</label>
                            <select id="device1-room">
                                <option value="room1">قاعة المختبر</option>
                                <option value="room2">قاعة الرياضيات</option>
                                <option value="room3">قاعة العلوم</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>التاريخ:</label>
                            <input type="date" id="device1-date" value="">
                        </div>
                        <div class="form-group">
                            <label>الوقت:</label>
                            <select id="device1-time">
                                <option value="08:15-09:00">08:15-09:00</option>
                                <option value="09:00-09:45">09:00-09:45</option>
                                <option value="09:45-10:30">09:45-10:30</option>
                            </select>
                        </div>
                        <button onclick="attemptBooking('device1', 'أحمد')">إنشاء حجز آمن</button>
                    </div>
                    
                    <div class="conflict-alert" id="device1-conflict"></div>
                    <div class="success-alert" id="device1-success"></div>
                </div>

                <!-- الجهاز الثاني -->
                <div class="device-simulator">
                    <div class="status-indicator" id="device2-status"></div>
                    <div class="device-header">💻 جهاز الأستاذة فاطمة</div>
                    
                    <div class="booking-form">
                        <div class="form-group">
                            <label>المادة:</label>
                            <select id="device2-subject">
                                <option value="الفيزياء">الفيزياء</option>
                                <option value="الكيمياء">الكيمياء</option>
                                <option value="الأحياء">الأحياء</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>القاعة:</label>
                            <select id="device2-room">
                                <option value="room1">قاعة المختبر</option>
                                <option value="room2">قاعة الرياضيات</option>
                                <option value="room3">قاعة العلوم</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>التاريخ:</label>
                            <input type="date" id="device2-date" value="">
                        </div>
                        <div class="form-group">
                            <label>الوقت:</label>
                            <select id="device2-time">
                                <option value="08:15-09:00">08:15-09:00</option>
                                <option value="09:00-09:45">09:00-09:45</option>
                                <option value="09:45-10:30">09:45-10:30</option>
                            </select>
                        </div>
                        <button onclick="attemptBooking('device2', 'فاطمة')">إنشاء حجز آمن</button>
                    </div>
                    
                    <div class="conflict-alert" id="device2-conflict"></div>
                    <div class="success-alert" id="device2-success"></div>
                </div>
            </div>
        </div>

        <!-- اختبارات متقدمة -->
        <div class="demo-section">
            <h2>🧪 اختبارات الضغط والتعارضات</h2>
            <button onclick="testSimultaneousBooking()">اختبار الحجز المتزامن</button>
            <button onclick="testMassiveConflict()">اختبار تعارض جماعي</button>
            <button onclick="testOfflineScenario()">اختبار سيناريو عدم الاتصال</button>
            <button onclick="testNetworkLatency()">محاكاة بطء الشبكة</button>
            <button onclick="testSystemRecovery()">اختبار استعادة النظام</button>
            <button onclick="clearAllTests()">مسح جميع الاختبارات</button>
        </div>

        <!-- خط زمني للأحداث -->
        <div class="demo-section">
            <h2>⏱️ سجل الأحداث المباشر</h2>
            <div class="timeline" id="timeline"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // إعدادات Firebase
        window.FIREBASE_ENABLED = true;
        window.FIREBASE_READY = false;

        const firebaseConfig = {
            apiKey: "AIzaSyCddo_kfYs8wO_xzZgf2WsWDvBWW8wC8rE",
            authDomain: "zawiyah-76151.firebaseapp.com",
            projectId: "zawiyah-76151",
            storageBucket: "zawiyah-76151.appspot.com",
            messagingSenderId: "259480775839",
            appId: "1:259480775839:web:0a95d39bfeb45f4c3abd83"
        };

        try {
            if (window.FIREBASE_ENABLED && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
                window.FIREBASE_READY = true;
            }
        } catch (error) {
            console.warn('⚠️ فشل في تهيئة Firebase:', error);
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        function isFirebaseReady() {
            return window.FIREBASE_ENABLED && window.FIREBASE_READY && window.db;
        }

        // إحصائيات الاختبار
        let testStats = {
            preventedConflicts: 0,
            successfulBookings: 0,
            activeLocks: 0,
            avgSyncSpeed: 0
        };
    </script>

    <!-- تحميل النظام -->
    <script src="dataManager.js"></script>
    <script src="conflictPrevention.js"></script>

    <script>
        // تهيئة النظام
        document.addEventListener('DOMContentLoaded', async function() {
            // تعيين التاريخ الحالي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('device1-date').value = today;
            document.getElementById('device2-date').value = today;
            
            logEvent('🚀 بدء نظام منع التعارضات', 'info');
            
            // انتظار تهيئة النظام
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // تسجيل دالة للإشعارات
            if (window.conflictPrevention) {
                window.conflictPrevention.onConflictDetected((type, data) => {
                    handleConflictNotification(type, data);
                });
            }
            
            // تحديث الإحصائيات كل ثانيتين
            setInterval(updateStats, 2000);
            
            updateDeviceStatus();
            logEvent('✅ النظام جاهز للاختبار', 'success');
        });

        function logEvent(message, type = 'info') {
            const timeline = document.getElementById('timeline');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            
            const eventHtml = `
                <div class="timeline-item">
                    <span class="timeline-time">${time}</span>
                    <span class="${className}">${message}</span>
                </div>
            `;
            
            timeline.innerHTML = eventHtml + timeline.innerHTML;
            
            // إبقاء آخر 50 حدث فقط
            const items = timeline.querySelectorAll('.timeline-item');
            if (items.length > 50) {
                for (let i = 50; i < items.length; i++) {
                    items[i].remove();
                }
            }
        }

        function updateStats() {
            try {
                if (window.conflictPrevention) {
                    const stats = window.conflictPrevention.getSystemStats();
                    document.getElementById('active-locks').textContent = stats.activeLocks;
                    testStats.activeLocks = stats.activeLocks;
                }
                
                document.getElementById('prevented-conflicts').textContent = testStats.preventedConflicts;
                document.getElementById('successful-bookings').textContent = testStats.successfulBookings;
                document.getElementById('sync-speed').textContent = testStats.avgSyncSpeed + 'ms';
                
            } catch (error) {
                console.error('خطأ في تحديث الإحصائيات:', error);
            }
        }

        function updateDeviceStatus() {
            const device1Status = document.getElementById('device1-status');
            const device2Status = document.getElementById('device2-status');
            
            if (isFirebaseReady()) {
                device1Status.className = 'status-indicator';
                device2Status.className = 'status-indicator';
            } else {
                device1Status.className = 'status-indicator status-offline';
                device2Status.className = 'status-indicator status-offline';
            }
        }

        async function attemptBooking(deviceId, teacherName) {
            const startTime = Date.now();
            
            try {
                logEvent(`📱 ${teacherName} يحاول إنشاء حجز من ${deviceId}`, 'info');
                
                // تحديث حالة الجهاز
                document.getElementById(deviceId + '-status').className = 'status-indicator status-syncing';
                
                // جمع بيانات النموذج
                const reservation = {
                    id: 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    subject: document.getElementById(deviceId + '-subject').value,
                    room: document.getElementById(deviceId + '-room').value,
                    date: document.getElementById(deviceId + '-date').value,
                    time: document.getElementById(deviceId + '-time').value,
                    teacher: `أ. ${teacherName}`,
                    grade: '10',
                    section: 'أ',
                    phone: '99887766',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // محاولة الحجز الآمن
                const result = await window.conflictPrevention.safeReservation(reservation, teacherName);
                
                const syncTime = Date.now() - startTime;
                testStats.avgSyncSpeed = Math.round((testStats.avgSyncSpeed + syncTime) / 2);
                
                // إخفاء الرسائل السابقة
                document.getElementById(deviceId + '-conflict').style.display = 'none';
                document.getElementById(deviceId + '-success').style.display = 'none';
                
                if (result.success) {
                    // نجح الحجز
                    document.getElementById(deviceId + '-success').innerHTML = `
                        ✅ تم إنشاء الحجز بنجاح!<br>
                        <small>القاعة: ${reservation.room} | الوقت: ${reservation.time}</small>
                    `;
                    document.getElementById(deviceId + '-success').style.display = 'block';
                    document.getElementById(deviceId + '-status').className = 'status-indicator';
                    
                    testStats.successfulBookings++;
                    logEvent(`✅ ${teacherName}: حجز ناجح - ${reservation.subject} في ${reservation.room}`, 'success');
                    
                } else {
                    // فشل الحجز بسبب تعارض
                    let conflictMessage = `❌ ${result.error}`;
                    
                    if (result.details && result.details.conflicts) {
                        conflictMessage += '<br><strong>التعارضات:</strong><br>';
                        result.details.conflicts.forEach(conflict => {
                            conflictMessage += `• ${conflict.message}<br>`;
                        });
                    }
                    
                    if (result.details && result.details.suggestions) {
                        conflictMessage += '<br><strong>اقتراحات:</strong><br>';
                        result.details.suggestions.slice(0, 2).forEach(suggestion => {
                            conflictMessage += `• ${suggestion.message}<br>`;
                        });
                    }
                    
                    document.getElementById(deviceId + '-conflict').innerHTML = conflictMessage;
                    document.getElementById(deviceId + '-conflict').style.display = 'block';
                    document.getElementById(deviceId + '-status').className = 'status-indicator status-offline';
                    
                    testStats.preventedConflicts++;
                    logEvent(`⚠️ ${teacherName}: تم منع تعارض - ${result.error}`, 'warning');
                }
                
            } catch (error) {
                document.getElementById(deviceId + '-conflict').innerHTML = `❌ خطأ في النظام: ${error.message}`;
                document.getElementById(deviceId + '-conflict').style.display = 'block';
                document.getElementById(deviceId + '-status').className = 'status-indicator status-offline';
                
                logEvent(`❌ ${teacherName}: خطأ في الحجز - ${error.message}`, 'error');
            }
            
            updateStats();
        }

        async function testSimultaneousBooking() {
            logEvent('🧪 بدء اختبار الحجز المتزامن', 'info');
            
            // تعيين نفس البيانات للجهازين
            document.getElementById('device1-room').value = 'room1';
            document.getElementById('device1-time').value = '08:15-09:00';
            document.getElementById('device2-room').value = 'room1';
            document.getElementById('device2-time').value = '08:15-09:00';
            
            // محاولة الحجز من الجهازين في نفس الوقت
            const promises = [
                attemptBooking('device1', 'أحمد'),
                new Promise(resolve => setTimeout(() => {
                    attemptBooking('device2', 'فاطمة').then(resolve);
                }, 100)) // تأخير بسيط لمحاكاة الشبكة
            ];
            
            await Promise.all(promises);
            logEvent('✅ انتهى اختبار الحجز المتزامن', 'success');
        }

        async function testMassiveConflict() {
            logEvent('🧪 بدء اختبار التعارض الجماعي', 'info');
            
            const rooms = ['room1', 'room2'];
            const times = ['08:15-09:00', '09:00-09:45'];
            const teachers = ['أحمد', 'فاطمة', 'محمد', 'عائشة', 'علي'];
            
            const promises = [];
            
            // إنشاء 10 محاولات حجز متضاربة
            for (let i = 0; i < 10; i++) {
                const reservation = {
                    id: 'mass_test_' + i,
                    subject: `مادة ${i + 1}`,
                    room: rooms[i % 2], // تناوب بين قاعتين
                    date: new Date().toISOString().split('T')[0],
                    time: times[0], // نفس الوقت للجميع
                    teacher: `أ. ${teachers[i % teachers.length]}`,
                    grade: '10',
                    section: 'أ',
                    phone: '99887766',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                promises.push(
                    window.conflictPrevention.safeReservation(reservation, teachers[i % teachers.length])
                        .then(result => {
                            if (result.success) {
                                testStats.successfulBookings++;
                                logEvent(`✅ حجز جماعي ناجح: ${reservation.subject}`, 'success');
                            } else {
                                testStats.preventedConflicts++;
                                logEvent(`⚠️ حجز جماعي منع: ${reservation.subject}`, 'warning');
                            }
                        })
                );
                
                // تأخير بسيط بين المحاولات
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            await Promise.all(promises);
            logEvent('✅ انتهى اختبار التعارض الجماعي', 'success');
            updateStats();
        }

        async function testOfflineScenario() {
            logEvent('🧪 بدء اختبار سيناريو عدم الاتصال', 'info');
            
            // إيقاف Firebase مؤقتاً
            const wasEnabled = window.FIREBASE_ENABLED;
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
            
            updateDeviceStatus();
            logEvent('📡 تم قطع الاتصال عن Firebase', 'warning');
            
            // محاولة حجز في وضع عدم الاتصال
            document.getElementById('device1-room').value = 'room2';
            document.getElementById('device1-time').value = '09:45-10:30';
            
            await attemptBooking('device1', 'أحمد');
            
            // إعادة تفعيل Firebase بعد 3 ثواني
            setTimeout(() => {
                window.FIREBASE_ENABLED = wasEnabled;
                if (window.db && wasEnabled) {
                    window.FIREBASE_READY = true;
                }
                updateDeviceStatus();
                logEvent('📡 تم استعادة الاتصال بـ Firebase', 'success');
            }, 3000);
        }

        async function testNetworkLatency() {
            logEvent('🧪 بدء محاكاة بطء الشبكة', 'info');
            
            // إبطاء المزامنة مؤقتاً
            if (window.conflictPrevention) {
                const originalInterval = window.conflictPrevention.syncInterval;
                window.conflictPrevention.syncInterval = 5000; // 5 ثوان
                
                logEvent('🐌 تم إبطاء المزامنة إلى 5 ثوان', 'warning');
                
                // اختبار حجز مع الشبكة البطيئة
                await attemptBooking('device1', 'أحمد');
                
                // إعادة السرعة الطبيعية بعد 10 ثوان
                setTimeout(() => {
                    window.conflictPrevention.syncInterval = originalInterval;
                    logEvent('⚡ تم استعادة سرعة المزامنة الطبيعية', 'success');
                }, 10000);
            }
        }

        async function testSystemRecovery() {
            logEvent('🧪 بدء اختبار استعادة النظام', 'info');
            
            try {
                // محاكاة عطل في النظام
                if (window.conflictPrevention) {
                    window.conflictPrevention.stopRealTimeSync();
                    logEvent('💥 تم إيقاف المزامنة الفورية', 'error');
                    
                    // محاولة حجز أثناء العطل
                    await attemptBooking('device2', 'فاطمة');
                    
                    // استعادة النظام بعد 5 ثوان
                    setTimeout(() => {
                        window.conflictPrevention.startRealTimeSync();
                        logEvent('🔧 تم استعادة النظام بنجاح', 'success');
                    }, 5000);
                }
            } catch (error) {
                logEvent('❌ خطأ في اختبار الاستعادة: ' + error.message, 'error');
            }
        }

        async function clearAllTests() {
            if (!confirm('هل أنت متأكد من مسح جميع بيانات الاختبار؟')) return;
            
            try {
                // مسح البيانات
                await window.dataManager.saveData('reservations', []);
                
                // إعادة تعيين الإحصائيات
                testStats = {
                    preventedConflicts: 0,
                    successfulBookings: 0,
                    activeLocks: 0,
                    avgSyncSpeed: 0
                };
                
                // مسح الأقفال
                if (window.conflictPrevention) {
                    window.conflictPrevention.activeLocks.clear();
                }
                
                // مسح الرسائل
                document.getElementById('device1-conflict').style.display = 'none';
                document.getElementById('device1-success').style.display = 'none';
                document.getElementById('device2-conflict').style.display = 'none';
                document.getElementById('device2-success').style.display = 'none';
                
                updateStats();
                logEvent('🗑️ تم مسح جميع بيانات الاختبار', 'success');
                
            } catch (error) {
                logEvent('❌ خطأ في مسح البيانات: ' + error.message, 'error');
            }
        }

        function handleConflictNotification(type, data) {
            switch (type) {
                case 'data_updated':
                    logEvent(`📊 تم تحديث البيانات: ${data.newReservations} حجز جديد`, 'info');
                    break;
                case 'conflict_detected':
                    logEvent(`⚠️ تم اكتشاف تعارض: ${data.type}`, 'warning');
                    break;
                case 'lock_created':
                    logEvent(`🔒 تم إنشاء قفل: ${data.key}`, 'info');
                    break;
                default:
                    logEvent(`📢 إشعار: ${type}`, 'info');
            }
        }
    </script>
</body>
</html>