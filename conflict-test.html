<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
        }
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .demo-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        .conflict-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .device-simulator {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff9a9e;
            position: relative;
        }
        .device-header {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }
        .status-offline { background: #dc3545; }
        .status-syncing { background: #ffc107; animation: pulse 1s infinite; }
        .booking-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ff9a9e;
            font-size: 12px;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        button {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .conflict-alert {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .success-alert {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .stats-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #fad0c4;
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
        }
        .timeline {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .timeline-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .timeline-time {
            color: #666;
            font-weight: bold;
            display: inline-block;
            width: 80px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ›¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</h1>
            <p>Ù…Ø­Ø§ÙƒØ§Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« ØªØ¹Ø§Ø±Ø¶Ø§Øª ÙÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</p>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="stats-panel">
            <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="active-locks">0</div>
                    <div class="stat-label">Ø£Ù‚ÙØ§Ù„ Ù†Ø´Ø·Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="prevented-conflicts">0</div>
                    <div class="stat-label">ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù…Ù†Ø¹Øª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successful-bookings">0</div>
                    <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ù†Ø§Ø¬Ø­Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sync-speed">0ms</div>
                    <div class="stat-label">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</div>
                </div>
            </div>
        </div>

        <!-- Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© -->
        <div class="demo-section">
            <h2>ğŸ“± Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</h2>
            <div class="conflict-demo">
                <!-- Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø£ÙˆÙ„ -->
                <div class="device-simulator">
                    <div class="status-indicator" id="device1-status"></div>
                    <div class="device-header">ğŸ“± Ø¬Ù‡Ø§Ø² Ø§Ù„Ø£Ø³ØªØ§Ø° Ø£Ø­Ù…Ø¯</div>
                    
                    <div class="booking-form">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                            <select id="device1-subject">
                                <option value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                                <option value="Ø§Ù„Ø¹Ù„ÙˆÙ…">Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                                <option value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù‚Ø§Ø¹Ø©:</label>
                            <select id="device1-room">
                                <option value="room1">Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±</option>
                                <option value="room2">Ù‚Ø§Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                                <option value="room3">Ù‚Ø§Ø¹Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                            <input type="date" id="device1-date" value="">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙˆÙ‚Øª:</label>
                            <select id="device1-time">
                                <option value="08:15-09:00">08:15-09:00</option>
                                <option value="09:00-09:45">09:00-09:45</option>
                                <option value="09:45-10:30">09:45-10:30</option>
                            </select>
                        </div>
                        <button onclick="attemptBooking('device1', 'Ø£Ø­Ù…Ø¯')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¢Ù…Ù†</button>
                    </div>
                    
                    <div class="conflict-alert" id="device1-conflict"></div>
                    <div class="success-alert" id="device1-success"></div>
                </div>

                <!-- Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø«Ø§Ù†ÙŠ -->
                <div class="device-simulator">
                    <div class="status-indicator" id="device2-status"></div>
                    <div class="device-header">ğŸ’» Ø¬Ù‡Ø§Ø² Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© ÙØ§Ø·Ù…Ø©</div>
                    
                    <div class="booking-form">
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                            <select id="device2-subject">
                                <option value="Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡">Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</option>
                                <option value="Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡">Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
                                <option value="Ø§Ù„Ø£Ø­ÙŠØ§Ø¡">Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù‚Ø§Ø¹Ø©:</label>
                            <select id="device2-room">
                                <option value="room1">Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±</option>
                                <option value="room2">Ù‚Ø§Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                                <option value="room3">Ù‚Ø§Ø¹Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                            <input type="date" id="device2-date" value="">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙˆÙ‚Øª:</label>
                            <select id="device2-time">
                                <option value="08:15-09:00">08:15-09:00</option>
                                <option value="09:00-09:45">09:00-09:45</option>
                                <option value="09:45-10:30">09:45-10:30</option>
                            </select>
                        </div>
                        <button onclick="attemptBooking('device2', 'ÙØ§Ø·Ù…Ø©')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ø¢Ù…Ù†</button>
                    </div>
                    
                    <div class="conflict-alert" id="device2-conflict"></div>
                    <div class="success-alert" id="device2-success"></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© -->
        <div class="demo-section">
            <h2>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</h2>
            <button onclick="testSimultaneousBooking()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†</button>
            <button onclick="testMassiveConflict()">Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø§Ø±Ø¶ Ø¬Ù…Ø§Ø¹ÙŠ</button>
            <button onclick="testOfflineScenario()">Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button onclick="testNetworkLatency()">Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø·Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©</button>
            <button onclick="testSystemRecovery()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <button onclick="clearAllTests()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
        </div>

        <!-- Ø®Ø· Ø²Ù…Ù†ÙŠ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« -->
        <div class="demo-section">
            <h2>â±ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
            <div class="timeline" id="timeline"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        window.FIREBASE_ENABLED = true;
        window.FIREBASE_READY = false;

        const firebaseConfig = {
            apiKey: "AIzaSyCddo_kfYs8wO_xzZgf2WsWDvBWW8wC8rE",
            authDomain: "zawiyah-76151.firebaseapp.com",
            projectId: "zawiyah-76151",
            storageBucket: "zawiyah-76151.appspot.com",
            messagingSenderId: "259480775839",
            appId: "1:259480775839:web:0a95d39bfeb45f4c3abd83"
        };

        try {
            if (window.FIREBASE_ENABLED && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
                window.FIREBASE_READY = true;
            }
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        function isFirebaseReady() {
            return window.FIREBASE_ENABLED && window.FIREBASE_READY && window.db;
        }

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        let testStats = {
            preventedConflicts: 0,
            successfulBookings: 0,
            activeLocks: 0,
            avgSyncSpeed: 0
        };
    </script>

    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… -->
    <script src="dataManager.js"></script>
    <script src="conflictPrevention.js"></script>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        document.addEventListener('DOMContentLoaded', async function() {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('device1-date').value = today;
            document.getElementById('device2-date').value = today;
            
            logEvent('ğŸš€ Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª', 'info');
            
            // Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø§Ù„Ø© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            if (window.conflictPrevention) {
                window.conflictPrevention.onConflictDetected((type, data) => {
                    handleConflictNotification(type, data);
                });
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setInterval(updateStats, 2000);
            
            updateDeviceStatus();
            logEvent('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success');
        });

        function logEvent(message, type = 'info') {
            const timeline = document.getElementById('timeline');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            
            const eventHtml = `
                <div class="timeline-item">
                    <span class="timeline-time">${time}</span>
                    <span class="${className}">${message}</span>
                </div>
            `;
            
            timeline.innerHTML = eventHtml + timeline.innerHTML;
            
            // Ø¥Ø¨Ù‚Ø§Ø¡ Ø¢Ø®Ø± 50 Ø­Ø¯Ø« ÙÙ‚Ø·
            const items = timeline.querySelectorAll('.timeline-item');
            if (items.length > 50) {
                for (let i = 50; i < items.length; i++) {
                    items[i].remove();
                }
            }
        }

        function updateStats() {
            try {
                if (window.conflictPrevention) {
                    const stats = window.conflictPrevention.getSystemStats();
                    document.getElementById('active-locks').textContent = stats.activeLocks;
                    testStats.activeLocks = stats.activeLocks;
                }
                
                document.getElementById('prevented-conflicts').textContent = testStats.preventedConflicts;
                document.getElementById('successful-bookings').textContent = testStats.successfulBookings;
                document.getElementById('sync-speed').textContent = testStats.avgSyncSpeed + 'ms';
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
            }
        }

        function updateDeviceStatus() {
            const device1Status = document.getElementById('device1-status');
            const device2Status = document.getElementById('device2-status');
            
            if (isFirebaseReady()) {
                device1Status.className = 'status-indicator';
                device2Status.className = 'status-indicator';
            } else {
                device1Status.className = 'status-indicator status-offline';
                device2Status.className = 'status-indicator status-offline';
            }
        }

        async function attemptBooking(deviceId, teacherName) {
            const startTime = Date.now();
            
            try {
                logEvent(`ğŸ“± ${teacherName} ÙŠØ­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¬Ø² Ù…Ù† ${deviceId}`, 'info');
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
                document.getElementById(deviceId + '-status').className = 'status-indicator status-syncing';
                
                // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                const reservation = {
                    id: 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    subject: document.getElementById(deviceId + '-subject').value,
                    room: document.getElementById(deviceId + '-room').value,
                    date: document.getElementById(deviceId + '-date').value,
                    time: document.getElementById(deviceId + '-time').value,
                    teacher: `Ø£. ${teacherName}`,
                    grade: '10',
                    section: 'Ø£',
                    phone: '99887766',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù…Ù†
                const result = await window.conflictPrevention.safeReservation(reservation, teacherName);
                
                const syncTime = Date.now() - startTime;
                testStats.avgSyncSpeed = Math.round((testStats.avgSyncSpeed + syncTime) / 2);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                document.getElementById(deviceId + '-conflict').style.display = 'none';
                document.getElementById(deviceId + '-success').style.display = 'none';
                
                if (result.success) {
                    // Ù†Ø¬Ø­ Ø§Ù„Ø­Ø¬Ø²
                    document.getElementById(deviceId + '-success').innerHTML = `
                        âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!<br>
                        <small>Ø§Ù„Ù‚Ø§Ø¹Ø©: ${reservation.room} | Ø§Ù„ÙˆÙ‚Øª: ${reservation.time}</small>
                    `;
                    document.getElementById(deviceId + '-success').style.display = 'block';
                    document.getElementById(deviceId + '-status').className = 'status-indicator';
                    
                    testStats.successfulBookings++;
                    logEvent(`âœ… ${teacherName}: Ø­Ø¬Ø² Ù†Ø§Ø¬Ø­ - ${reservation.subject} ÙÙŠ ${reservation.room}`, 'success');
                    
                } else {
                    // ÙØ´Ù„ Ø§Ù„Ø­Ø¬Ø² Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶
                    let conflictMessage = `âŒ ${result.error}`;
                    
                    if (result.details && result.details.conflicts) {
                        conflictMessage += '<br><strong>Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª:</strong><br>';
                        result.details.conflicts.forEach(conflict => {
                            conflictMessage += `â€¢ ${conflict.message}<br>`;
                        });
                    }
                    
                    if (result.details && result.details.suggestions) {
                        conflictMessage += '<br><strong>Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª:</strong><br>';
                        result.details.suggestions.slice(0, 2).forEach(suggestion => {
                            conflictMessage += `â€¢ ${suggestion.message}<br>`;
                        });
                    }
                    
                    document.getElementById(deviceId + '-conflict').innerHTML = conflictMessage;
                    document.getElementById(deviceId + '-conflict').style.display = 'block';
                    document.getElementById(deviceId + '-status').className = 'status-indicator status-offline';
                    
                    testStats.preventedConflicts++;
                    logEvent(`âš ï¸ ${teacherName}: ØªÙ… Ù…Ù†Ø¹ ØªØ¹Ø§Ø±Ø¶ - ${result.error}`, 'warning');
                }
                
            } catch (error) {
                document.getElementById(deviceId + '-conflict').innerHTML = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: ${error.message}`;
                document.getElementById(deviceId + '-conflict').style.display = 'block';
                document.getElementById(deviceId + '-status').className = 'status-indicator status-offline';
                
                logEvent(`âŒ ${teacherName}: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¬Ø² - ${error.message}`, 'error');
            }
            
            updateStats();
        }

        async function testSimultaneousBooking() {
            logEvent('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†', 'info');
            
            // ØªØ¹ÙŠÙŠÙ† Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ù‡Ø§Ø²ÙŠÙ†
            document.getElementById('device1-room').value = 'room1';
            document.getElementById('device1-time').value = '08:15-09:00';
            document.getElementById('device2-room').value = 'room1';
            document.getElementById('device2-time').value = '08:15-09:00';
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø¬Ø² Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
            const promises = [
                attemptBooking('device1', 'Ø£Ø­Ù…Ø¯'),
                new Promise(resolve => setTimeout(() => {
                    attemptBooking('device2', 'ÙØ§Ø·Ù…Ø©').then(resolve);
                }, 100)) // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
            ];
            
            await Promise.all(promises);
            logEvent('âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†', 'success');
        }

        async function testMassiveConflict() {
            logEvent('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ', 'info');
            
            const rooms = ['room1', 'room2'];
            const times = ['08:15-09:00', '09:00-09:45'];
            const teachers = ['Ø£Ø­Ù…Ø¯', 'ÙØ§Ø·Ù…Ø©', 'Ù…Ø­Ù…Ø¯', 'Ø¹Ø§Ø¦Ø´Ø©', 'Ø¹Ù„ÙŠ'];
            
            const promises = [];
            
            // Ø¥Ù†Ø´Ø§Ø¡ 10 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø­Ø¬Ø² Ù…ØªØ¶Ø§Ø±Ø¨Ø©
            for (let i = 0; i < 10; i++) {
                const reservation = {
                    id: 'mass_test_' + i,
                    subject: `Ù…Ø§Ø¯Ø© ${i + 1}`,
                    room: rooms[i % 2], // ØªÙ†Ø§ÙˆØ¨ Ø¨ÙŠÙ† Ù‚Ø§Ø¹ØªÙŠÙ†
                    date: new Date().toISOString().split('T')[0],
                    time: times[0], // Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¬Ù…ÙŠØ¹
                    teacher: `Ø£. ${teachers[i % teachers.length]}`,
                    grade: '10',
                    section: 'Ø£',
                    phone: '99887766',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                promises.push(
                    window.conflictPrevention.safeReservation(reservation, teachers[i % teachers.length])
                        .then(result => {
                            if (result.success) {
                                testStats.successfulBookings++;
                                logEvent(`âœ… Ø­Ø¬Ø² Ø¬Ù…Ø§Ø¹ÙŠ Ù†Ø§Ø¬Ø­: ${reservation.subject}`, 'success');
                            } else {
                                testStats.preventedConflicts++;
                                logEvent(`âš ï¸ Ø­Ø¬Ø² Ø¬Ù…Ø§Ø¹ÙŠ Ù…Ù†Ø¹: ${reservation.subject}`, 'warning');
                            }
                        })
                );
                
                // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            await Promise.all(promises);
            logEvent('âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ', 'success');
            updateStats();
        }

        async function testOfflineScenario() {
            logEvent('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„', 'info');
            
            // Ø¥ÙŠÙ‚Ø§Ù Firebase Ù…Ø¤Ù‚ØªØ§Ù‹
            const wasEnabled = window.FIREBASE_ENABLED;
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
            
            updateDeviceStatus();
            logEvent('ğŸ“¡ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù† Firebase', 'warning');
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø¬Ø² ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„
            document.getElementById('device1-room').value = 'room2';
            document.getElementById('device1-time').value = '09:45-10:30';
            
            await attemptBooking('device1', 'Ø£Ø­Ù…Ø¯');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Firebase Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                window.FIREBASE_ENABLED = wasEnabled;
                if (window.db && wasEnabled) {
                    window.FIREBASE_READY = true;
                }
                updateDeviceStatus();
                logEvent('ğŸ“¡ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase', 'success');
            }, 3000);
        }

        async function testNetworkLatency() {
            logEvent('ğŸ§ª Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø·Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©', 'info');
            
            // Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
            if (window.conflictPrevention) {
                const originalInterval = window.conflictPrevention.syncInterval;
                window.conflictPrevention.syncInterval = 5000; // 5 Ø«ÙˆØ§Ù†
                
                logEvent('ğŸŒ ØªÙ… Ø¥Ø¨Ø·Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ù„Ù‰ 5 Ø«ÙˆØ§Ù†', 'warning');
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø¬Ø² Ù…Ø¹ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·ÙŠØ¦Ø©
                await attemptBooking('device1', 'Ø£Ø­Ù…Ø¯');
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
                setTimeout(() => {
                    window.conflictPrevention.syncInterval = originalInterval;
                    logEvent('âš¡ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©', 'success');
                }, 10000);
            }
        }

        async function testSystemRecovery() {
            logEvent('ğŸ§ª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', 'info');
            
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
                if (window.conflictPrevention) {
                    window.conflictPrevention.stopRealTimeSync();
                    logEvent('ğŸ’¥ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©', 'error');
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø¬Ø² Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø·Ù„
                    await attemptBooking('device2', 'ÙØ§Ø·Ù…Ø©');
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
                    setTimeout(() => {
                        window.conflictPrevention.startRealTimeSync();
                        logEvent('ğŸ”§ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    }, 5000);
                }
            } catch (error) {
                logEvent('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ' + error.message, 'error');
            }
        }

        async function clearAllTests() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return;
            
            try {
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await window.dataManager.saveData('reservations', []);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                testStats = {
                    preventedConflicts: 0,
                    successfulBookings: 0,
                    activeLocks: 0,
                    avgSyncSpeed: 0
                };
                
                // Ù…Ø³Ø­ Ø§Ù„Ø£Ù‚ÙØ§Ù„
                if (window.conflictPrevention) {
                    window.conflictPrevention.activeLocks.clear();
                }
                
                // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                document.getElementById('device1-conflict').style.display = 'none';
                document.getElementById('device1-success').style.display = 'none';
                document.getElementById('device2-conflict').style.display = 'none';
                document.getElementById('device2-success').style.display = 'none';
                
                updateStats();
                logEvent('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success');
                
            } catch (error) {
                logEvent('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            }
        }

        function handleConflictNotification(type, data) {
            switch (type) {
                case 'data_updated':
                    logEvent(`ğŸ“Š ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${data.newReservations} Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯`, 'info');
                    break;
                case 'conflict_detected':
                    logEvent(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ¹Ø§Ø±Ø¶: ${data.type}`, 'warning');
                    break;
                case 'lock_created':
                    logEvent(`ğŸ”’ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙÙ„: ${data.key}`, 'info');
                    break;
                default:
                    logEvent(`ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø±: ${type}`, 'info');
            }
        }
    </script>
</body>
</html>