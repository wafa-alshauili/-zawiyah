<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¬ÙŠÙ†</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            background: #007acc; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            margin: 8px; 
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover { background: #005a9e; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .test-data {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        #results { 
            background: white; 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin-top: 20px; 
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¬ÙŠÙ†</h1>
        <p>Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù†Ø¸Ø§Ù… localStorage + Firebase Ù…Ø¹ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div class="test-section">
            <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <div class="status-grid">
                <div class="status-card">
                    <strong>Firebase:</strong>
                    <div id="firebase-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                </div>
                <div class="status-card">
                    <strong>localStorage:</strong>
                    <div id="localstorage-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                </div>
                <div class="status-card">
                    <strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong>
                    <div id="datamanager-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
                </div>
                <div class="status-card">
                    <strong>Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©:</strong>
                    <div id="sync-status">Ù„Ø§ ØªÙˆØ¬Ø¯</div>
                </div>
            </div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª -->
        <div class="test-section">
            <h2>ğŸ« Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</h2>
            <button onclick="testAddRoom()">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            <button onclick="testGetRooms()">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</button>
            <button onclick="testUpdateRoom()">ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø©</button>
            <button onclick="testDeleteRoom()">Ø­Ø°Ù Ù‚Ø§Ø¹Ø©</button>
            <button onclick="testRoomsSync()">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</button>
            
            <div class="test-data" id="rooms-data">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¹Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
            </div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
        <div class="test-section">
            <h2>ğŸ“… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
            <button onclick="testAddReservation()">Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
            <button onclick="testGetReservations()">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
            <button onclick="testUpdateReservation()">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ø²</button>
            <button onclick="testDeleteReservation()">Ø­Ø°Ù Ø­Ø¬Ø²</button>
            <button onclick="testReservationsSync()">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
            
            <div class="test-data" id="reservations-data">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¬ÙˆØ²Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
            </div>
        </div>

        <!-- Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„ØªØ±Ø§Ø¬Ø¹ -->
        <div class="test-section">
            <h2>ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„ØªØ±Ø§Ø¬Ø¹</h2>
            <button onclick="testFirebaseDisable()">Ù…Ø­Ø§ÙƒØ§Ø© ÙØ´Ù„ Firebase</button>
            <button onclick="testFirebaseRestore()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Firebase</button>
            <button onclick="testForceSync()">ÙØ±Ø¶ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</button>
            <button onclick="testConflictResolution()">Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª</button>
            <button onclick="testBackupRestore()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            
            <div class="progress-bar" id="sync-progress" style="display:none;">
                <div class="progress-fill" id="sync-progress-fill"></div>
            </div>
        </div>

        <!-- ØªØ´Ø®ÙŠØµ Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="test-section">
            <h2>ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
            <button onclick="showDiagnostics()">Ø¹Ø±Ø¶ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ÙƒØ§Ù…Ù„</button>
            <button onclick="clearAllData()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button onclick="resetSystem()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
        <div id="results"></div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase - Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        window.FIREBASE_ENABLED = true;
        window.FIREBASE_READY = false;

        const firebaseConfig = {
            apiKey: "AIzaSyCddo_kfYs8wO_xzZgf2WsWDvBWW8wC8rE",
            authDomain: "zawiyah-76151.firebaseapp.com",
            projectId: "zawiyah-76151",
            storageBucket: "zawiyah-76151.appspot.com",
            messagingSenderId: "259480775839",
            appId: "1:259480775839:web:0a95d39bfeb45f4c3abd83"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        try {
            if (window.FIREBASE_ENABLED && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
                window.FIREBASE_READY = true;
            }
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        function isFirebaseReady() {
            return window.FIREBASE_ENABLED && window.FIREBASE_READY && window.db;
        }

        function disableFirebase() {
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            
            results.innerHTML += `<div><span class="${className}">${time}: ${message}</span></div>`;
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function updateStatus(element, status, type) {
            const statusElement = document.getElementById(element);
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            statusElement.innerHTML = `<span class="${className}">${status}</span>`;
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('sync-progress');
            const progressFill = document.getElementById('sync-progress-fill');
            
            if (percentage > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = percentage + '%';
            } else {
                progressBar.style.display = 'none';
            }
        }
    </script>

    <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <script src="dataManager.js"></script>

    <script>
        let testRoomId = 'test_room_' + Date.now();
        let testReservationId = 'test_reservation_' + Date.now();

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', async function() {
            log('ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...');
            
            // Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            updateSystemStatus();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
            setInterval(updateSystemStatus, 5000);
        });

        function updateSystemStatus() {
            // Ø­Ø§Ù„Ø© Firebase
            if (isFirebaseReady()) {
                updateStatus('firebase-status', 'Ù…ØªØµÙ„ ÙˆÙŠØ¹Ù…Ù„', 'success');
            } else {
                updateStatus('firebase-status', 'ØºÙŠØ± Ù…ØªØ§Ø­', 'warning');
            }

            // Ø­Ø§Ù„Ø© localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                updateStatus('localstorage-status', 'ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
            } catch (error) {
                updateStatus('localstorage-status', 'Ø®Ø·Ø£: ' + error.message, 'error');
            }

            // Ø­Ø§Ù„Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (window.dataManager && window.dataManager.isInitialized) {
                const diagnostics = window.dataManager.getDiagnostics();
                updateStatus('datamanager-status', 'Ø¬Ø§Ù‡Ø² ÙˆÙ…Ù‡ÙŠØ£', 'success');
                
                const syncStatus = diagnostics.syncStatus;
                if (syncStatus.status === 'success') {
                    updateStatus('sync-status', 'Ù†Ø¬Ø­Øª - ' + new Date(syncStatus.timestamp).toLocaleTimeString(), 'success');
                } else if (syncStatus.status === 'failed') {
                    updateStatus('sync-status', 'ÙØ´Ù„ - ' + (syncStatus.error || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'), 'error');
                } else {
                    updateStatus('sync-status', 'Ù„Ù… ØªØªÙ… Ø¨Ø¹Ø¯', 'info');
                }
            } else {
                updateStatus('datamanager-status', 'Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ø¹Ø¯', 'warning');
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª
        async function testAddRoom() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©...');
            updateProgress(20);

            const roomData = {
                id: testRoomId,
                name: 'Ù‚Ø§Ø¹Ø© Ø§Ø®ØªØ¨Ø§Ø± ' + Math.floor(Math.random() * 100),
                capacity: Math.floor(Math.random() * 50) + 20,
                location: 'Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„',
                equipment: ['Ù…ÙƒÙŠÙ', 'Ø¨Ø±ÙˆØ¬ÙŠÙƒØªØ±', 'Ø³Ø¨ÙˆØ±Ø© Ø°ÙƒÙŠØ©'],
                created: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            try {
                const rooms = await window.dataManager.getData('rooms');
                rooms[testRoomId] = roomData;
                
                const success = await window.dataManager.saveData('rooms', rooms);
                updateProgress(100);
                
                if (success) {
                    log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­: ${roomData.name}`, 'success');
                    await updateRoomsDisplay();
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¹Ø©', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¹Ø©: ${error.message}`, 'error');
            }
            
            updateProgress(0);
        }

        async function testGetRooms() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª...');
            
            try {
                const rooms = await window.dataManager.getData('rooms');
                const roomCount = Object.keys(rooms).length;
                
                log(`âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${roomCount} Ù‚Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                await updateRoomsDisplay();
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª: ${error.message}`, 'error');
            }
        }

        async function testUpdateRoom() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø©...');
            
            try {
                const rooms = await window.dataManager.getData('rooms');
                
                if (rooms[testRoomId]) {
                    rooms[testRoomId].capacity = Math.floor(Math.random() * 50) + 20;
                    rooms[testRoomId].lastModified = new Date().toISOString();
                    rooms[testRoomId].updated = true;
                    
                    const success = await window.dataManager.saveData('rooms', rooms);
                    
                    if (success) {
                        log(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ - Ø³Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${rooms[testRoomId].capacity}`, 'success');
                        await updateRoomsDisplay();
                    } else {
                        log('âŒ ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø©', 'error');
                    }
                } else {
                    log('âš ï¸ Ø§Ù„Ù‚Ø§Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'warning');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø©: ${error.message}`, 'error');
            }
        }

        async function testDeleteRoom() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ù‚Ø§Ø¹Ø©...');
            
            try {
                const rooms = await window.dataManager.getData('rooms');
                
                if (rooms[testRoomId]) {
                    delete rooms[testRoomId];
                    
                    const success = await window.dataManager.saveData('rooms', rooms);
                    
                    if (success) {
                        log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        await updateRoomsDisplay();
                    } else {
                        log('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø©', 'error');
                    }
                } else {
                    log('âš ï¸ Ø§Ù„Ù‚Ø§Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„Ø­Ø°Ù', 'warning');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø©: ${error.message}`, 'error');
            }
        }

        async function testRoomsSync() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ù…Ø¹ Firebase...');
            updateProgress(30);
            
            if (!isFirebaseReady()) {
                log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'warning');
                updateProgress(0);
                return;
            }

            try {
                const rooms = await window.dataManager.getData('rooms');
                updateProgress(60);
                
                const success = await window.dataManager.saveToFirebase('rooms', rooms);
                updateProgress(100);
                
                if (success) {
                    log('âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ù…Ø¹ Firebase Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ù…Ø¹ Firebase', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª: ${error.message}`, 'error');
            }
            
            updateProgress(0);
        }

        async function updateRoomsDisplay() {
            try {
                const rooms = await window.dataManager.getData('rooms');
                const roomsData = document.getElementById('rooms-data');
                
                if (Object.keys(rooms).length === 0) {
                    roomsData.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©';
                } else {
                    roomsData.innerHTML = '<pre>' + JSON.stringify(rooms, null, 2) + '</pre>';
                }
            } catch (error) {
                document.getElementById('rooms-data').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
        async function testAddReservation() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ø² ØªØ¬Ø±ÙŠØ¨ÙŠ...');
            
            const reservationData = {
                id: testReservationId,
                room: testRoomId,
                subject: 'Ù…Ø§Ø¯Ø© Ø§Ø®ØªØ¨Ø§Ø±',
                teacher: 'Ø£. Ø§Ø®ØªØ¨Ø§Ø±',
                grade: '10',
                section: 'Ø£',
                date: new Date().toISOString().split('T')[0],
                time: '08:00-09:00',
                phone: '1234567890',
                created: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            try {
                const reservations = await window.dataManager.getData('reservations');
                reservations.push(reservationData);
                
                const success = await window.dataManager.saveData('reservations', reservations);
                
                if (success) {
                    log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­: ${reservationData.subject}`, 'success');
                    await updateReservationsDisplay();
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¬Ø²', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¬Ø²: ${error.message}`, 'error');
            }
        }

        async function testGetReservations() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª...');
            
            try {
                const reservations = await window.dataManager.getData('reservations');
                
                log(`âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${reservations.length} Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                await updateReservationsDisplay();
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: ${error.message}`, 'error');
            }
        }

        async function updateReservationsDisplay() {
            try {
                const reservations = await window.dataManager.getData('reservations');
                const reservationsData = document.getElementById('reservations-data');
                
                if (reservations.length === 0) {
                    reservationsData.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©';
                } else {
                    reservationsData.innerHTML = '<pre>' + JSON.stringify(reservations, null, 2) + '</pre>';
                }
            } catch (error) {
                document.getElementById('reservations-data').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            }
        }

        // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„ØªØ±Ø§Ø¬Ø¹
        async function testFirebaseDisable() {
            log('ğŸ”„ Ù…Ø­Ø§ÙƒØ§Ø© ÙØ´Ù„ Firebase...');
            
            disableFirebase();
            if (window.dataManager) {
                window.dataManager.disableFirebase();
            }
            
            updateSystemStatus();
            log('âš ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù FirebaseØŒ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ localStorage ÙÙ‚Ø·', 'warning');
        }

        async function testFirebaseRestore() {
            log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Firebase...');
            
            window.FIREBASE_ENABLED = true;
            if (window.db) {
                window.FIREBASE_READY = true;
                if (window.dataManager) {
                    window.dataManager.checkFirebaseAvailability();
                }
            }
            
            updateSystemStatus();
            log('âœ… ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Firebase', 'success');
        }

        async function testForceSync() {
            log('ğŸ”„ ÙØ±Ø¶ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©...');
            updateProgress(10);
            
            try {
                if (!window.dataManager) {
                    throw new Error('Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­');
                }
                
                updateProgress(50);
                const success = await window.dataManager.forceSyncAll();
                updateProgress(100);
                
                if (success) {
                    log('âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ±Ø¶ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${error.message}`, 'error');
            }
            
            updateProgress(0);
            updateSystemStatus();
        }

        async function showDiagnostics() {
            log('ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù…...');
            
            try {
                if (window.dataManager) {
                    const diagnostics = window.dataManager.getDiagnostics();
                    
                    log('ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ:', 'info');
                    log(`- Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ÙÙ‡ÙŠØ£: ${diagnostics.isInitialized ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`, 'info');
                    log(`- Firebase Ù…ØªØ§Ø­: ${diagnostics.firebaseAvailable ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`, 'info');
                    log(`- Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ©: ${diagnostics.syncInProgress ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`, 'info');
                    log(`- Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ${diagnostics.lastSyncTime || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}`, 'info');
                    log(`- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${diagnostics.syncStatus.status}`, 'info');
                    log(`- Ù…ÙØ§ØªÙŠØ­ localStorage: ${diagnostics.localStorageKeys.length}`, 'info');
                    
                    document.getElementById('results').innerHTML += 
                        '<div class="test-data"><pre>' + JSON.stringify(diagnostics, null, 2) + '</pre></div>';
                } else {
                    log('âŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„ØªØ´Ø®ÙŠØµ', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ: ${error.message}`, 'error');
            }
        }

        async function clearAllData() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;
            
            log('ğŸ”„ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            
            try {
                // Ù…Ø³Ø­ localStorage
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('school_') || key.startsWith('firebase_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                if (window.dataManager) {
                    await window.dataManager.init();
                }
                
                await updateRoomsDisplay();
                await updateReservationsDisplay();
                updateSystemStatus();
                
                log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
            }
        }

        async function resetSystem() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ')) return;
            
            log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…...');
            
            try {
                await clearAllData();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (window.dataManager) {
                    window.dataManager = new DataManager();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                updateSystemStatus();
                log('âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…: ${error.message}`, 'error');
            }
        }

        // Ø¨Ø§Ù‚ÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
        async function testUpdateReservation() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ø²...');
            
            try {
                const reservations = await window.dataManager.getData('reservations');
                const reservationIndex = reservations.findIndex(r => r.id === testReservationId);
                
                if (reservationIndex !== -1) {
                    reservations[reservationIndex].subject = 'Ù…Ø§Ø¯Ø© Ù…Ø¹Ø¯Ù„Ø©';
                    reservations[reservationIndex].lastModified = new Date().toISOString();
                    
                    const success = await window.dataManager.saveData('reservations', reservations);
                    
                    if (success) {
                        log('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        await updateReservationsDisplay();
                    } else {
                        log('âŒ ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²', 'error');
                    }
                } else {
                    log('âš ï¸ Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'warning');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²: ${error.message}`, 'error');
            }
        }

        async function testDeleteReservation() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø°Ù Ø­Ø¬Ø²...');
            
            try {
                const reservations = await window.dataManager.getData('reservations');
                const reservationIndex = reservations.findIndex(r => r.id === testReservationId);
                
                if (reservationIndex !== -1) {
                    reservations.splice(reservationIndex, 1);
                    
                    const success = await window.dataManager.saveData('reservations', reservations);
                    
                    if (success) {
                        log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        await updateReservationsDisplay();
                    } else {
                        log('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²', 'error');
                    }
                } else {
                    log('âš ï¸ Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„Ø­Ø°Ù', 'warning');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²: ${error.message}`, 'error');
            }
        }

        async function testReservationsSync() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¹ Firebase...');
            updateProgress(30);
            
            if (!isFirebaseReady()) {
                log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 'warning');
                updateProgress(0);
                return;
            }

            try {
                const reservations = await window.dataManager.getData('reservations');
                updateProgress(60);
                
                const success = await window.dataManager.saveToFirebase('reservations', reservations);
                updateProgress(100);
                
                if (success) {
                    log('âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¹ Firebase Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¹ Firebase', 'error');
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: ${error.message}`, 'error');
            }
            
            updateProgress(0);
        }

        async function testConflictResolution() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª...');
            
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const rooms = await window.dataManager.getData('rooms');
                const conflictRoomId = 'conflict_room_' + Date.now();
                
                // Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
                rooms[conflictRoomId] = {
                    id: conflictRoomId,
                    name: 'Ù‚Ø§Ø¹Ø© ØªØ¹Ø§Ø±Ø¶ Ù…Ø­Ù„ÙŠØ©',
                    capacity: 30,
                    lastModified: new Date().toISOString()
                };
                
                await window.dataManager.saveToLocalStorage('rooms', rooms);
                log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù…ØªØ¹Ø§Ø±Ø¶Ø©', 'success');
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Firebase
                if (isFirebaseReady()) {
                    const firebaseRooms = { ...rooms };
                    firebaseRooms[conflictRoomId].name = 'Ù‚Ø§Ø¹Ø© ØªØ¹Ø§Ø±Ø¶ Firebase';
                    firebaseRooms[conflictRoomId].capacity = 40;
                    
                    await window.dataManager.saveToFirebase('rooms', firebaseRooms);
                    log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù…ØªØ¹Ø§Ø±Ø¶Ø©', 'success');
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
                    await window.dataManager.syncDataInBackground('rooms');
                    log('âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø¢Ù„ÙŠØ© Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª', 'success');
                }
                
                await updateRoomsDisplay();
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª: ${error.message}`, 'error');
            }
        }

        async function testBackupRestore() {
            log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...');
            
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                const testData = {
                    backup_test: {
                        name: 'Ù‚Ø§Ø¹Ø© Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
                        capacity: 25
                    }
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await window.dataManager.saveToLocalStorage('rooms', testData);
                log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', 'success');
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø®Ø·Ø£ ÙˆØ¥ÙØ³Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                localStorage.setItem('school_rooms', 'invalid json data');
                log('âš ï¸ ØªÙ… Ø¥ÙØ³Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø®Ø·Ø£', 'warning');
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                const restoredData = window.dataManager.restoreFromBackup('rooms');
                
                if (restoredData && restoredData.backup_test) {
                    log('âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
                }
                
                await updateRoomsDisplay();
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>