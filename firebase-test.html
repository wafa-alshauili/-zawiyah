<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Firebase</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .test-section { 
            background: #f5f5f5; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        button { 
            background: #007acc; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #005a9e; }
        #results { background: white; border: 1px solid #ddd; padding: 15px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Firebase - Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</h1>

    <div class="test-section">
        <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</h2>
        <div id="connection-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
        <button onclick="testFirebaseConnection()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
        <button onclick="testLocalStorage()">Ø§Ø®ØªØ¨Ø§Ø± localStorage</button>
        <button onclick="testDataWrite()">Ø§Ø®ØªØ¨Ø§Ø± ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="testDataRead()">Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick="testFailover()">Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø§Ø¬Ø¹</button>
    </div>

    <div class="test-section">
        <h2>ğŸ« Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h2>
        <button onclick="testRoomsData()">Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</button>
        <button onclick="testReservationsData()">Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
        <button onclick="testSync()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
    </div>

    <div id="results"></div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase - Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† index.html
        window.FIREBASE_ENABLED = true;
        window.FIREBASE_READY = false;

        const firebaseConfig = {
            apiKey: "AIzaSyCddo_kfYs8wO_xzZgf2WsWDvBWW8wC8rE",
            authDomain: "zawiyah-76151.firebaseapp.com",
            projectId: "zawiyah-76151",
            storageBucket: "zawiyah-76151.appspot.com",
            messagingSenderId: "259480775839",
            appId: "1:259480775839:web:0a95d39bfeb45f4c3abd83"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        let initializationResult = '';
        try {
            if (window.FIREBASE_ENABLED && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
                window.FIREBASE_READY = true;
                initializationResult = '<span class="success">âœ… Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­</span>';
            }
        } catch (error) {
            initializationResult = `<span class="error">âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase: ${error.message}</span>`;
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('connection-status').innerHTML = initializationResult;
        });

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        function isFirebaseReady() {
            return window.FIREBASE_ENABLED && window.FIREBASE_READY && window.db;
        }

        function disableFirebase() {
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
            log('ğŸ”„ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù FirebaseØŒ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù€ localStorage');
        }

        function log(message) {
            const results = document.getElementById('results');
            results.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            console.log(message);
        }

        // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        async function testFirebaseConnection() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...');
            
            if (!isFirebaseReady()) {
                log('<span class="error">âŒ Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø£Ùˆ ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡</span>');
                return;
            }

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø³ÙŠØ·Ø© Ù…Ù† Firestore
                const testDoc = await db.collection('test').doc('connection').get();
                log('<span class="success">âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>');
            } catch (error) {
                log(`<span class="error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}</span>`);
                if (error.code === 'permission-denied') {
                    log('<span class="warning">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - Ø³ÙŠØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù€ localStorage</span>');
                    disableFirebase();
                }
            }
        }

        function testLocalStorage() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± localStorage...');
            
            try {
                const testKey = 'firebase_test_' + Date.now();
                const testData = { test: true, timestamp: Date.now() };
                
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                
                if (retrieved && retrieved.test === true) {
                    log('<span class="success">âœ… localStorage ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­</span>');
                    localStorage.removeItem(testKey);
                } else {
                    log('<span class="error">âŒ Ø®Ø·Ø£ ÙÙŠ localStorage</span>');
                }
            } catch (error) {
                log(`<span class="error">âŒ Ø®Ø·Ø£ ÙÙŠ localStorage: ${error.message}</span>`);
            }
        }

        async function testDataWrite() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            
            const testData = {
                name: 'Ù‚Ø§Ø¹Ø© Ø§Ø®ØªØ¨Ø§Ø±',
                capacity: 30,
                timestamp: new Date().toISOString(),
                created_by: 'firebase_test'
            };

            // Ø§Ø®ØªØ¨Ø§Ø± localStorage Ø£ÙˆÙ„Ø§Ù‹
            try {
                localStorage.setItem('test_room', JSON.stringify(testData));
                log('<span class="success">âœ… ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage Ù†Ø¬Ø­Øª</span>');
            } catch (error) {
                log(`<span class="error">âŒ ÙØ´Ù„ ÙƒØªØ§Ø¨Ø© localStorage: ${error.message}</span>`);
            }

            // Ø§Ø®ØªØ¨Ø§Ø± Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            if (isFirebaseReady()) {
                try {
                    await db.collection('test_rooms').doc('test_room').set(testData);
                    log('<span class="success">âœ… ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Ù†Ø¬Ø­Øª</span>');
                } catch (error) {
                    log(`<span class="error">âŒ ÙØ´Ù„ ÙƒØªØ§Ø¨Ø© Firebase: ${error.message}</span>`);
                    if (error.code === 'permission-denied') {
                        disableFirebase();
                    }
                }
            } else {
                log('<span class="warning">âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage ÙÙ‚Ø·</span>');
            }
        }

        async function testDataRead() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            
            // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† localStorage
            try {
                const localData = localStorage.getItem('test_room');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    log(`<span class="success">âœ… Ù‚Ø±Ø§Ø¡Ø© localStorage: ${parsed.name}</span>`);
                } else {
                    log('<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage</span>');
                }
            } catch (error) {
                log(`<span class="error">âŒ Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© localStorage: ${error.message}</span>`);
            }

            // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Firebase
            if (isFirebaseReady()) {
                try {
                    const doc = await db.collection('test_rooms').doc('test_room').get();
                    if (doc.exists) {
                        const data = doc.data();
                        log(`<span class="success">âœ… Ù‚Ø±Ø§Ø¡Ø© Firebase: ${data.name}</span>`);
                    } else {
                        log('<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase</span>');
                    }
                } catch (error) {
                    log(`<span class="error">âŒ Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Firebase: ${error.message}</span>`);
                }
            }
        }

        function testFailover() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø§Ø¬Ø¹...');
            
            log(`<span class="warning">ğŸ”„ Ø­Ø§Ù„Ø© Firebase Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù: ${isFirebaseReady()}</span>`);
            
            // Ø¥ÙŠÙ‚Ø§Ù Firebase
            disableFirebase();
            
            log(`<span class="success">âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Firebase Ø¨Ù†Ø¬Ø§Ø­: ${isFirebaseReady()}</span>`);
            log('<span class="success">âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ localStorage ÙÙ‚Ø·</span>');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Firebase (Ù…Ø­Ø§ÙƒØ§Ø©)
            setTimeout(() => {
                window.FIREBASE_ENABLED = true;
                if (window.db) {
                    window.FIREBASE_READY = true;
                    log('<span class="success">âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Firebase</span>');
                }
            }, 2000);
        }

        // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
        function testRoomsData() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©...');
            
            const rooms = localStorage.getItem('school_rooms');
            if (rooms) {
                const parsed = JSON.parse(rooms);
                log(`<span class="success">âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${Object.keys(parsed).length} Ù‚Ø§Ø¹Ø©</span>`);
                log(`ğŸ“‹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª: ${Object.values(parsed).map(r => r.name).join(', ')}`);
            } else {
                log('<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</span>');
            }
        }

        function testReservationsData() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©...');
            
            const reservations = localStorage.getItem('school_reservations');
            if (reservations) {
                const parsed = JSON.parse(reservations);
                log(`<span class="success">âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${parsed.length} Ø­Ø¬Ø²</span>`);
                if (parsed.length > 0) {
                    const latest = parsed[parsed.length - 1];
                    log(`ğŸ“‹ Ø¢Ø®Ø± Ø­Ø¬Ø²: ${latest.subject} - ${latest.grade}${latest.section}`);
                }
            } else {
                log('<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</span>');
            }
        }

        async function testSync() {
            log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
            
            if (!isFirebaseReady()) {
                log('<span class="error">âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© - Firebase ØºÙŠØ± Ù…ØªØ§Ø­</span>');
                return;
            }

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª
                const rooms = localStorage.getItem('school_rooms');
                if (rooms) {
                    const parsed = JSON.parse(rooms);
                    await db.collection('school_data').doc('rooms').set({
                        data: parsed,
                        last_updated: new Date().toISOString(),
                        source: 'test_sync'
                    });
                    log('<span class="success">âœ… ØªÙ… Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ù„Ù€ Firebase</span>');

                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const doc = await db.collection('school_data').doc('rooms').get();
                    if (doc.exists) {
                        const firebaseData = doc.data();
                        log(`<span class="success">âœ… ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ${Object.keys(firebaseData.data).length} Ù‚Ø§Ø¹Ø© Ù…Ù† Firebase</span>`);
                    }
                } else {
                    log('<span class="warning">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>');
                }
            } catch (error) {
                log(`<span class="error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${error.message}</span>`);
                if (error.code === 'permission-denied') {
                    log('<span class="warning">âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore</span>');
                    disableFirebase();
                }
            }
        }
    </script>
</body>
</html>