<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الحجوزات</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Arabic+Poetry:opsz,wght@16..72,400;16..72,700&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar">
	<div class="corner-logos">
		<img class="logo-ministry" src="https://i.ibb.co/HfwV7QB5/ministerylogo1-1.png" alt="شعار وزارة التربية والتعليم سلطنة عمان">
	</div>
</nav>

<main class="container">
		<div class="site-title-bar" style="text-align:center; margin: 40px auto 0 auto;">
					<span class="site-title">زاوية</span>
					<button id="menu-toggle" style="display:none; background:none; border:none; position:absolute; left:18px; top:18px; z-index:1100; cursor:pointer;">
				<span style="font-size:1.5em; color:#1b3767;">&#9776;</span>
					</button>
					<ul class="nav-links" id="nav-links" style="display:flex; justify-content:center; gap:32px; list-style:none; margin:28px auto 0 auto; padding:0; background:rgba(27,55,103,0.12); border-radius:16px; box-shadow:0 2px 12px rgba(27,55,103,0.08);">
			<li><a href="index.html" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">الرئيسية</a></li>
			<li><a href="reservations.html" class="active" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">الحجوزات</a></li>
			<li><a href="rooms.html" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">القاعات</a></li>
			</ul>
		</div>

<main class="container">
	<h1 class="main-title">زاوية</h1>

<h2>الحجوزات</h2>
<div id="week-controls" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
		<button id="prev-week">الأسبوع السابق</button>
		<span id="week-range" style="font-weight: bold;"></span>
		<button id="next-week">الأسبوع التالي</button>
		<label style="margin-right:20px;">تحديد بداية الأسبوع: <input type="date" id="week-date"></label>
</div>

<label for="room-select">اختر القاعة أولاً:</label>
<select id="room-select">
<option value="">-- اختر القاعة --</option>
</select>

<div id="room-warning" style="display:none;color:#b52b2b;background:#ffeaea;padding:10px 20px;margin:10px 0 0 0;border-radius:7px;font-weight:bold;text-align:center;"></div>

<!-- نموذج الحجز المتقدم -->
<div id="booking-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 id="booking-modal-title" style="color: #1b3767; margin: 0;">📝 حجز جديد</h3>
      <button onclick="closeBookingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
    </div>
    
    <form id="booking-form" onsubmit="submitBooking(event)">
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">👨‍🏫 اسم المعلم/المعلمة:</label>
        <input type="text" id="teacher-name" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;" placeholder="أدخل اسم المعلم">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">📞 رقم الهاتف:</label>
        <input type="tel" id="teacher-phone" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;" placeholder="مثال: 99123456">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">🎓 الصف:</label>
        <select id="grade-select" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;" onchange="updateSections()">
          <option value="">-- اختر الصف --</option>
          <option value="5">الصف الخامس</option>
          <option value="6">الصف السادس</option>
          <option value="7">الصف السابع</option>
          <option value="8">الصف الثامن</option>
          <option value="9">الصف التاسع</option>
          <option value="10">الصف العاشر</option>
          <option value="11">الصف الحادي عشر</option>
          <option value="12">الصف الثاني عشر</option>
        </select>
      </div>
      
      <div id="section-container" style="margin-bottom: 15px; display: none;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">📚 الشعبة:</label>
        <select id="section-select" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;">
          <option value="">-- اختر الشعبة --</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">📖 نوع المادة:</label>
        <select id="subject-type" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;" onchange="updateSubjectOptions()">
          <option value="">-- اختر نوع المادة --</option>
          <option value="regular">مادة أساسية</option>
          <option value="elective">مادة اختيارية (للصف 11 و 12 فقط)</option>
        </select>
      </div>
      
      <div id="regular-subject-container" style="margin-bottom: 15px; display: none;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">📚 المادة:</label>
        <select id="regular-subject" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;">
          <option value="">-- اختر المادة --</option>
          <option value="اللغة العربية">اللغة العربية</option>
          <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
          <option value="الرياضيات">الرياضيات</option>
          <option value="العلوم">العلوم</option>
          <option value="الدراسات الاجتماعية">الدراسات الاجتماعية</option>
          <option value="التربية الإسلامية">التربية الإسلامية</option>
          <option value="تقنية المعلومات">تقنية المعلومات</option>
          <option value="التربية الرياضية">التربية الرياضية</option>
          <option value="التربية الفنية">التربية الفنية</option>
          <option value="التربية الموسيقية">التربية الموسيقية</option>
        </select>
      </div>
      
      <div id="elective-subject-container" style="margin-bottom: 15px; display: none;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1b3767;">✏️ اسم المادة الاختيارية:</label>
        <input type="text" id="elective-subject" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;" placeholder="أدخل اسم المادة الاختيارية">
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        <button type="submit" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
          ✅ تأكيد الحجز
        </button>
        <button type="button" onclick="closeBookingModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
          ❌ إلغاء
        </button>
      </div>
    </form>
  </div>
</div>

<table id="reservation-table" style="display:none; margin-top:20px;">
<thead>
<tr>
<th>اليوم والتاريخ</th>
<th>الفترة الأولى</th>
<th>الفترة الثانية</th>
<th>الفترة الثالثة</th>
<th>الفترة الرابعة</th>
<th>الفترة الخامسة</th>
<th>الفترة السادسة</th>
<th>الفترة السابعة</th>
<th>النشاط</th>
<th>الطابور</th>
</tr>
</thead>
<tbody>
<tr><td class="day-cell" data-date="0">الأحد <span class="date-span"></span></td><td data-time="sun-1"></td><td data-time="sun-2"></td><td data-time="sun-3"></td><td data-time="sun-4"></td><td data-time="sun-5"></td><td data-time="sun-6"></td><td data-time="sun-7"></td><td data-time="sun-activity"></td><td data-time="sun-assembly"></td></tr>
<tr><td class="day-cell" data-date="1">الإثنين <span class="date-span"></span></td><td data-time="mon-1"></td><td data-time="mon-2"></td><td data-time="mon-3"></td><td data-time="mon-4"></td><td data-time="mon-5"></td><td data-time="mon-6"></td><td data-time="mon-7"></td><td data-time="mon-activity"></td><td data-time="mon-assembly"></td></tr>
<tr><td class="day-cell" data-date="2">الثلاثاء <span class="date-span"></span></td><td data-time="tue-1"></td><td data-time="tue-2"></td><td data-time="tue-3"></td><td data-time="tue-4"></td><td data-time="tue-5"></td><td data-time="tue-6"></td><td data-time="tue-7"></td><td data-time="tue-activity"></td><td data-time="tue-assembly"></td></tr>
<tr><td class="day-cell" data-date="3">الأربعاء <span class="date-span"></span></td><td data-time="wed-1"></td><td data-time="wed-2"></td><td data-time="wed-3"></td><td data-time="wed-4"></td><td data-time="wed-5"></td><td data-time="wed-6"></td><td data-time="wed-7"></td><td data-time="wed-activity"></td><td data-time="wed-assembly"></td></tr>
<tr><td class="day-cell" data-date="4">الخميس <span class="date-span"></span></td><td data-time="thu-1"></td><td data-time="thu-2"></td><td data-time="thu-3"></td><td data-time="thu-4"></td><td data-time="thu-5"></td><td data-time="thu-6"></td><td data-time="thu-7"></td><td data-time="thu-activity"></td><td data-time="thu-assembly"></td></tr>
</tbody>
</table>

<button id="export-btn" class="export-btn">⬇ تصدير الإحصائيات</button>
</main>

<script src="script.js"></script>
<script>
// نظام الحجوزات
let currentWeek = 0;
let selectedRoom = null;
let reservations = [];

// تحميل البيانات من localStorage
function loadData() {
  // تحميل القاعات
  const savedRooms = localStorage.getItem('school_rooms');
  const rooms = savedRooms ? JSON.parse(savedRooms) : ['المختبر', 'قاعة الحاسوب', 'المكتبة', 'القاعة الرئيسية'];
  
  // ملء قائمة القاعات
  const roomSelect = document.getElementById('room-select');
  roomSelect.innerHTML = '<option value="">-- اختر القاعة --</option>';
  rooms.forEach(room => {
    const option = document.createElement('option');
    option.value = room;
    option.textContent = room;
    roomSelect.appendChild(option);
  });
  
  // تحميل الحجوزات
  const savedReservations = localStorage.getItem('school_reservations');
  reservations = savedReservations ? JSON.parse(savedReservations) : [];
}

// حفظ الحجوزات
function saveReservations() {
  localStorage.setItem('school_reservations', JSON.stringify(reservations));
}

// حساب تواريخ الأسبوع (يبدأ بالأحد - التقويم الميلادي)
function getWeekDates(weekOffset = 0) {
  const today = new Date();
  const currentDay = today.getDay(); // 0 = أحد, 1 = إثنين, 2 = ثلاثاء, إلخ
  const sunday = new Date(today);
  // حساب تاريخ يوم الأحد من الأسبوع المطلوب
  sunday.setDate(today.getDate() - currentDay + (weekOffset * 7));
  
  const dates = [];
  for (let i = 0; i < 5; i++) { // من الأحد إلى الخميس (5 أيام دراسية)
    const date = new Date(sunday);
    date.setDate(sunday.getDate() + i);
    dates.push(date);
  }
  return dates;
}

// تحديث عرض الأسبوع
function updateWeekDisplay() {
  const dates = getWeekDates(currentWeek);
  const weekRangeSpan = document.getElementById('week-range');
  
  // استخدام التقويم الميلادي
  const startDate = dates[0].toLocaleDateString('en-GB').split('/').reverse().join('/');
  const endDate = dates[4].toLocaleDateString('en-GB').split('/').reverse().join('/');
  weekRangeSpan.textContent = `${startDate} - ${endDate}`;
  
  // تحديث تواريخ الأيام في الجدول
  const daySpans = document.querySelectorAll('.date-span');
  daySpans.forEach((span, index) => {
    if (dates[index]) {
      const day = dates[index].getDate();
      const month = dates[index].getMonth() + 1;
      span.textContent = `${day}/${month}`;
    }
  });
  
  // تحديث حقل التاريخ
  document.getElementById('week-date').value = dates[0].toISOString().split('T')[0];
}

// عرض جدول الحجوزات
function showReservationTable() {
  if (!selectedRoom) return;
  
  document.getElementById('room-warning').style.display = 'none';
  document.getElementById('reservation-table').style.display = 'table';
  
  // مسح الحجوزات السابقة
  const cells = document.querySelectorAll('td[data-time]');
  cells.forEach(cell => {
    cell.innerHTML = '';
    cell.style.backgroundColor = '';
    cell.style.cursor = 'pointer';
    cell.onclick = () => bookSlot(cell);
  });
  
  // عرض الحجوزات الحالية
  const weekDates = getWeekDates(currentWeek);
  
  // تجميع الحجوزات حسب الخانة الزمنية للغرفة الصفية
  const reservationsByTimeSlot = {};
  
  reservations.forEach(reservation => {
    if (reservation.room === selectedRoom) {
      const reservationDate = new Date(reservation.date);
      const dayIndex = weekDates.findIndex(date => 
        date.toDateString() === reservationDate.toDateString()
      );
      
      if (dayIndex !== -1) {
        const key = reservation.timeSlot;
        if (!reservationsByTimeSlot[key]) {
          reservationsByTimeSlot[key] = [];
        }
        reservationsByTimeSlot[key].push(reservation);
      }
    }
  });
  
  // عرض الحجوزات في الجدول
  Object.keys(reservationsByTimeSlot).forEach(timeSlot => {
    const cell = document.querySelector(`td[data-time="${timeSlot}"]`);
    if (cell) {
      const reservationsInSlot = reservationsByTimeSlot[timeSlot];
      
      if (selectedRoom === 'غرفة صفية' && reservationsInSlot.length > 1) {
        // عرض حجوزات متعددة للغرفة الصفية
        let cellContent = '<div style="font-size: 0.8em; line-height: 1.2;">';
        
        reservationsInSlot.forEach((reservation, index) => {
          const gradeText = reservation.grade ? `${reservation.grade}` : '';
          const sectionText = reservation.section ? `${reservation.section}` : '';
          const bgColor = index % 2 === 0 ? '#e3f2fd' : '#f1f8e9';
          
          cellContent += `
            <div style="background: ${bgColor}; padding: 4px; border-radius: 3px; margin-bottom: 2px; border: 1px solid #ddd;">
              <div style="font-weight: bold; color: #1565c0; font-size: 0.9em;">👨‍🏫 ${reservation.teacher}</div>
              <div style="color: #1976d2; font-size: 0.85em;">📚 ${reservation.subject}</div>
              ${gradeText && sectionText ? `<div style="color: #424242; font-size: 0.8em;">🎓 ${gradeText}-${sectionText}</div>` : ''}
              <button onclick="showReservationOptions('${reservation.id}', '${reservation.phone || ''}')" 
                      style="background: #ff9800; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 0.7em; cursor: pointer; width: 100%; margin-top: 1px;">
                ⚙️ إدارة
              </button>
            </div>
          `;
        });
        
        cellContent += '</div>';
        
        // إضافة زر "حجز جديد" للغرفة الصفية
        if (selectedRoom === 'غرفة صفية') {
          cellContent += `
            <div style="text-align: center; margin-top: 8px;">
              <button onclick="bookNewSlotInClassroom('${timeSlot}')" 
                      style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ➕ حجز جديد
              </button>
            </div>
          `;
        }
        
        cellContent += '</div>';
        cell.innerHTML = cellContent;
        cell.style.backgroundColor = '#fff3e0';
        cell.onclick = null;
      } else {
        // عرض حجز واحد (للقاعات العادية أو حجز واحد في الغرفة الصفية)
        const reservation = reservationsInSlot[0];
        const gradeText = reservation.grade ? `الصف ${reservation.grade}` : '';
        const sectionText = reservation.section ? `الشعبة ${reservation.section}` : '';
        const phoneText = reservation.phone ? `📱 ${reservation.phone}` : '';
        
        let cellContent = `
          <div style="background: #e3f2fd; padding: 8px; border-radius: 4px; font-size: 0.85em; line-height: 1.3;">
            <div style="font-weight: bold; color: #1565c0; margin-bottom: 2px;">👨‍🏫 ${reservation.teacher}</div>
            <div style="color: #1976d2; margin-bottom: 2px;">📚 ${reservation.subject}</div>
            ${gradeText && sectionText ? `<div style="color: #424242; font-size: 0.8em; margin-bottom: 2px;">🎓 ${gradeText} - ${sectionText}</div>` : ''}
            ${phoneText ? `<div style="color: #424242; font-size: 0.8em; margin-bottom: 3px;">${phoneText}</div>` : ''}
            <button onclick="showReservationOptions('${reservation.id}', '${reservation.phone || ''}')" 
                    style="background: #ff9800; color: white; border: none; padding: 3px 8px; border-radius: 3px; font-size: 0.75em; margin-top: 2px; cursor: pointer; width: 100%;">
              ⚙️ إدارة الحجز
            </button>
          </div>
        `;
        
        // إضافة زر "حجز جديد" للغرفة الصفية حتى لو كان هناك حجز واحد
        if (selectedRoom === 'غرفة صفية') {
          cellContent += `
            <div style="text-align: center; margin-top: 6px;">
              <button onclick="bookNewSlotInClassroom('${reservation.timeSlot}')" 
                      style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 0.75em; cursor: pointer; font-weight: bold; width: 100%;">
                ➕ حجز إضافي
              </button>
            </div>
          `;
        }
        
        cell.innerHTML = cellContent;
        cell.style.backgroundColor = '#f3e5f5';
        cell.onclick = null;
      }
    }
  });
}

// حجز فترة زمنية
function bookSlot(cell) {
  // للغرفة الصفية، السماح بالحجز حتى لو كانت مشغولة
  if (selectedRoom === 'غرفة صفية') {
    openBookingModal(cell);
    return;
  }
  
  // للقاعات الأخرى، منع الحجز إذا كانت مشغولة
  if (cell.innerHTML.trim()) {
    alert('⚠️ هذه الفترة محجوزة بالفعل');
    return;
  }
  
  openBookingModal(cell);
}

// حجز جديد في الغرفة الصفية
function bookNewSlotInClassroom(timeSlot) {
  if (selectedRoom !== 'غرفة صفية') {
    alert('⚠️ هذه الوظيفة متاحة فقط للغرفة الصفية');
    return;
  }
  
  // إنشاء خانة وهمية للاستفادة من النظام الحالي
  const dummyCell = document.createElement('td');
  dummyCell.setAttribute('data-time', timeSlot);
  dummyCell.setAttribute('data-day', getCurrentDayFromTimeSlot(timeSlot));
  
  currentBookingCell = dummyCell;
  openBookingModal(dummyCell);
}

// دالة مساعدة لاستخراج اليوم من الفترة الزمنية
function getCurrentDayFromTimeSlot(timeSlot) {
  // البحث عن أول حجز في نفس الفترة لمعرفة اليوم
  const existingReservation = reservations.find(r => 
    r.room === selectedRoom && r.timeSlot === timeSlot
  );
  
  if (existingReservation) {
    const date = new Date(existingReservation.date);
    const weekDates = getWeekDates(currentWeek);
    const dayIndex = weekDates.findIndex(weekDate => 
      weekDate.toDateString() === date.toDateString()
    );
    return dayIndex;
  }
  
  // إذا لم نجد حجز موجود، نستخدم اليوم الحالي
  return new Date().getDay();
}

// إلغاء حجز
function cancelReservation(reservationId) {
  if (confirm('هل أنت متأكد من إلغاء هذا الحجز؟')) {
    reservations = reservations.filter(r => r.id !== reservationId);
    saveReservations();
    showReservationTable();
    alert('✅ تم إلغاء الحجز بنجاح');
  }
}

// تصدير البيانات
function exportData() {
  if (!selectedRoom) {
    alert('⚠️ يرجى اختيار قاعة أولاً');
    return;
  }
  
  const roomReservations = reservations.filter(r => r.room === selectedRoom);
  const csvContent = "data:text/csv;charset=utf-8," + 
    "التاريخ,اليوم,الفترة,المعلم,رقم الهاتف,الصف,الشعبة,المادة,نوع المادة\n" +
    roomReservations.map(r => {
      const date = new Date(r.date);
      const dayName = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'][date.getDay()];
      const grade = r.grade ? `الصف ${r.grade}` : '';
      const section = r.section ? `الشعبة ${r.section}` : '';
      const subjectType = r.subjectType === 'elective' ? 'اختيارية' : 'أساسية';
      // استخدام التقويم الميلادي
      const gregorianDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
      return `${gregorianDate},${dayName},${r.timeSlot},${r.teacher},${r.phone || ''},${grade},${section},${r.subject},${subjectType}`;
    }).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  const today = new Date();
  const todayFormatted = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
  link.setAttribute("download", `حجوزات_${selectedRoom}_${todayFormatted}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// دوال النموذج المتقدم
let currentBookingCell = null;

function openBookingModal(cell) {
  currentBookingCell = cell;
  const modal = document.getElementById('booking-modal');
  const title = document.getElementById('booking-modal-title');
  
  // استخراج معلومات الفترة والتاريخ
  const timeSlot = cell.getAttribute('data-time');
  const timeText = getTimeSlotText(timeSlot);
  const dayText = getDayText(timeSlot);
  
  title.textContent = `📝 حجز ${selectedRoom} - ${dayText} ${timeText}`;
  modal.style.display = 'block';
  
  // إعادة تعيين النموذج
  document.getElementById('booking-form').reset();
  document.getElementById('section-container').style.display = 'none';
  document.getElementById('regular-subject-container').style.display = 'none';
  document.getElementById('elective-subject-container').style.display = 'none';
}

function closeBookingModal() {
  document.getElementById('booking-modal').style.display = 'none';
  currentBookingCell = null;
}

function updateSections() {
  const gradeSelect = document.getElementById('grade-select');
  const sectionContainer = document.getElementById('section-container');
  const sectionSelect = document.getElementById('section-select');
  const subjectType = document.getElementById('subject-type');
  
  const grade = gradeSelect.value;
  
  if (grade) {
    sectionContainer.style.display = 'block';
    sectionSelect.innerHTML = '<option value="">-- اختر الشعبة --</option>';
    
    let sectionCount;
    if (grade >= 5 && grade <= 10) {
      sectionCount = 3; // 3 شعب للصفوف 5-10
    } else if (grade >= 11 && grade <= 12) {
      sectionCount = 6; // 6 شعب للصفوف 11-12
    }
    
    for (let i = 1; i <= sectionCount; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `الشعبة ${i}`;
      sectionSelect.appendChild(option);
    }
    
    // تحديث خيارات نوع المادة
    subjectType.innerHTML = '<option value="">-- اختر نوع المادة --</option>';
    subjectType.innerHTML += '<option value="regular">مادة أساسية</option>';
    
    if (grade >= 11 && grade <= 12) {
      subjectType.innerHTML += '<option value="elective">مادة اختيارية</option>';
    }
  } else {
    sectionContainer.style.display = 'none';
  }
}

function updateSubjectOptions() {
  const subjectType = document.getElementById('subject-type').value;
  const regularContainer = document.getElementById('regular-subject-container');
  const electiveContainer = document.getElementById('elective-subject-container');
  
  // إخفاء كلا الحاويتين
  regularContainer.style.display = 'none';
  electiveContainer.style.display = 'none';
  
  if (subjectType === 'regular') {
    regularContainer.style.display = 'block';
  } else if (subjectType === 'elective') {
    electiveContainer.style.display = 'block';
  }
}

function submitBooking(event) {
  event.preventDefault();
  
  if (!currentBookingCell) return;
  
  // جمع البيانات من النموذج
  const teacherName = document.getElementById('teacher-name').value.trim();
  const teacherPhone = document.getElementById('teacher-phone').value.trim();
  const grade = document.getElementById('grade-select').value;
  const section = document.getElementById('section-select').value;
  const subjectType = document.getElementById('subject-type').value;
  
  let subject;
  if (subjectType === 'regular') {
    subject = document.getElementById('regular-subject').value;
  } else if (subjectType === 'elective') {
    subject = document.getElementById('elective-subject').value.trim();
  }
  
  // التحقق من البيانات
  if (!teacherName || !teacherPhone || !grade || !section || !subject) {
    alert('⚠️ يرجى ملء جميع الحقول المطلوبة');
    return;
  }
  
  // التحقق من رقم الهاتف
  const phoneRegex = /^[0-9]{8}$/;
  if (!phoneRegex.test(teacherPhone)) {
    alert('⚠️ يرجى إدخال رقم هاتف صحيح (8 أرقام)');
    return;
  }
  
  const timeSlot = currentBookingCell.getAttribute('data-time');
  const weekDates = getWeekDates(currentWeek);
  
  // تحديد التاريخ حسب اليوم
  let dayIndex;
  if (timeSlot.startsWith('sun')) dayIndex = 0;
  else if (timeSlot.startsWith('mon')) dayIndex = 1;
  else if (timeSlot.startsWith('tue')) dayIndex = 2;
  else if (timeSlot.startsWith('wed')) dayIndex = 3;
  else if (timeSlot.startsWith('thu')) dayIndex = 4;

  // فحص التعارضات قبل إضافة الحجز
  const targetDate = weekDates[dayIndex].toISOString();
  const existingReservations = reservations.filter(r => 
    r.room === selectedRoom && 
    r.timeSlot === timeSlot && 
    r.date === targetDate
  );

  // منطق منع التعارضات حسب نوع القاعة
  if (selectedRoom === 'غرفة صفية') {
    // للغرفة الصفية: يُمنع التعارض فقط إذا كان نفس الصف ونفس الشعبة
    const conflictingReservation = existingReservations.find(r => 
      r.grade === grade && r.section === section
    );
    
    if (conflictingReservation) {
      alert(`⚠️ تعارض في الحجز!\nيوجد حجز سابق لنفس الصف (${grade}) والشعبة (${section}) في نفس الوقت.\n\n👨‍🏫 المعلم: ${conflictingReservation.teacher}\n📚 المادة: ${conflictingReservation.subject}\n📱 الهاتف: ${conflictingReservation.phone || 'غير محدد'}`);
      return;
    }
  } else {
    // لباقي القاعات: يُمنع أي حجز إضافي في نفس الوقت
    if (existingReservations.length > 0) {
      const existingReservation = existingReservations[0];
      alert(`⚠️ القاعة محجوزة!\nيوجد حجز سابق في نفس الوقت.\n\n👨‍🏫 المعلم: ${existingReservation.teacher}\n📚 المادة: ${existingReservation.subject}\n🎓 الصف: ${existingReservation.grade} - الشعبة ${existingReservation.section}\n📱 الهاتف: ${existingReservation.phone || 'غير محدد'}`);
      return;
    }
  }
  
  // إنشاء الحجز الجديد
  const reservation = {
    id: Date.now().toString(),
    room: selectedRoom,
    teacher: teacherName,
    phone: teacherPhone,
    grade: grade,
    section: section,
    subject: subject,
    subjectType: subjectType,
    timeSlot: timeSlot,
    date: weekDates[dayIndex].toISOString(),
    createdAt: new Date().toISOString()
  };
  
  reservations.push(reservation);
  saveReservations();
  showReservationTable();
  closeBookingModal();
  
  // رسالة نجاح مخصصة حسب نوع القاعة
  if (selectedRoom === 'غرفة صفية' && existingReservations.length > 0) {
    alert(`✅ تم إضافة حجز إضافي بنجاح!\n🏫 القاعة: ${selectedRoom}\n👨‍🏫 المعلم: ${teacherName}\n📱 الهاتف: ${teacherPhone}\n🎓 الصف: ${grade} - الشعبة ${section}\n📚 المادة: ${subject}\n\n📝 ملاحظة: يوجد ${existingReservations.length} حجز آخر في نفس الوقت`);
  } else {
    alert(`✅ تم حجز القاعة بنجاح!\n🏫 القاعة: ${selectedRoom}\n👨‍🏫 المعلم: ${teacherName}\n📱 الهاتف: ${teacherPhone}\n🎓 الصف: ${grade} - الشعبة ${section}\n📚 المادة: ${subject}`);
  }
}

function getTimeSlotText(timeSlot) {
  const timeMap = {
    '1': 'الحصة الأولى (7:30 - 8:15)',
    '2': 'الحصة الثانية (8:15 - 9:00)',
    '3': 'الحصة الثالثة (9:00 - 9:45)',
    '4': 'الحصة الرابعة (10:15 - 11:00)',
    '5': 'الحصة الخامسة (11:00 - 11:45)',
    '6': 'الحصة السادسة (11:45 - 12:30)',
    '7': 'الحصة السابعة (1:00 - 1:45)'
  };
  
  const period = timeSlot.slice(-1);
  return timeMap[period] || `الحصة ${period}`;
}

function getDayText(timeSlot) {
  if (timeSlot.startsWith('sun')) return 'الأحد';
  if (timeSlot.startsWith('mon')) return 'الإثنين';
  if (timeSlot.startsWith('tue')) return 'الثلاثاء';
  if (timeSlot.startsWith('wed')) return 'الأربعاء';
  if (timeSlot.startsWith('thu')) return 'الخميس';
  return '';
}

// إدارة الحجوزات باستخدام رقم الهاتف
function showReservationOptions(reservationId, phoneNumber) {
  const reservation = reservations.find(r => r.id === reservationId);
  if (!reservation) {
    alert('❌ لم يتم العثور على الحجز');
    return;
  }
  
  let options = `🔧 إدارة الحجز:\n`;
  options += `👨‍🏫 المعلم: ${reservation.teacher}\n`;
  options += `📚 المادة: ${reservation.subject}\n`;
  if (reservation.grade && reservation.section) {
    options += `🎓 الصف: ${reservation.grade} - الشعبة ${reservation.section}\n`;
  }
  if (reservation.phone) {
    options += `📱 الهاتف: ${reservation.phone}\n`;
  }
  options += `\nاختر إجراءً:\n`;
  options += `1️⃣ إلغاء الحجز\n`;
  options += `2️⃣ تعديل الحجز\n`;
  options += `3️⃣ عرض التفاصيل\n`;
  options += `❌ إغلاق`;
  
  const choice = prompt(options + '\n\nأدخل رقم الخيار (1-3):');
  
  if (choice === '1') {
    cancelReservationWithPhone(reservationId, phoneNumber);
  } else if (choice === '2') {
    editReservation(reservationId, phoneNumber);
  } else if (choice === '3') {
    showReservationDetails(reservation);
  }
}

function cancelReservationWithPhone(reservationId, phoneNumber) {
  const reservation = reservations.find(r => r.id === reservationId);
  
  if (phoneNumber && reservation.phone) {
    const enteredPhone = prompt(`🔐 للتأكيد، أدخل رقم الهاتف المسجل:\n(الرقم المطلوب: ${reservation.phone})`);
    
    if (enteredPhone !== reservation.phone) {
      alert('❌ رقم الهاتف غير صحيح. لا يمكن إلغاء الحجز.');
      return;
    }
  }
  
  if (confirm(`هل أنت متأكد من إلغاء هذا الحجز؟\n\n👨‍🏫 المعلم: ${reservation.teacher}\n📚 المادة: ${reservation.subject}`)) {
    reservations = reservations.filter(r => r.id !== reservationId);
    saveReservations();
    showReservationTable();
    alert('✅ تم إلغاء الحجز بنجاح');
  }
}

function editReservation(reservationId, phoneNumber) {
  const reservation = reservations.find(r => r.id === reservationId);
  
  if (phoneNumber && reservation.phone) {
    const enteredPhone = prompt(`🔐 للتأكيد، أدخل رقم الهاتف المسجل:\n(الرقم المطلوب: ${reservation.phone})`);
    
    if (enteredPhone !== reservation.phone) {
      alert('❌ رقم الهاتف غير صحيح. لا يمكن تعديل الحجز.');
      return;
    }
  }
  
  alert('🔄 ميزة التعديل ستتوفر قريباً. يمكنك حالياً إلغاء الحجز وإنشاء حجز جديد.');
}

function showReservationDetails(reservation) {
  let details = `📋 تفاصيل الحجز:\n\n`;
  details += `🏢 القاعة: ${reservation.room}\n`;
  details += `👨‍🏫 المعلم: ${reservation.teacher}\n`;
  details += `📚 المادة: ${reservation.subject}\n`;
  
  if (reservation.grade && reservation.section) {
    details += `🎓 الصف: ${reservation.grade} - الشعبة ${reservation.section}\n`;
  }
  
  if (reservation.phone) {
    details += `📱 الهاتف: ${reservation.phone}\n`;
  }
  
  if (reservation.subjectType) {
    const typeText = reservation.subjectType === 'elective' ? 'اختيارية' : 'أساسية';
    details += `📖 نوع المادة: ${typeText}\n`;
  }
  
  const createdDate = new Date(reservation.createdAt);
  const createdFormatted = `${createdDate.getDate()}/${createdDate.getMonth() + 1}/${createdDate.getFullYear()} ${createdDate.getHours()}:${createdDate.getMinutes().toString().padStart(2, '0')}`;
  details += `📅 تاريخ الحجز: ${createdFormatted}\n`;
  
  const sessionDate = new Date(reservation.date);
  const sessionFormatted = `${sessionDate.getDate()}/${sessionDate.getMonth() + 1}/${sessionDate.getFullYear()}`;
  details += `🗓️ تاريخ الجلسة: ${sessionFormatted}`;
  
  alert(details);
}

// تهيئة النظام
document.addEventListener('DOMContentLoaded', function() {
  loadData();
  updateWeekDisplay();
  
  // أحداث التحكم في الأسبوع
  document.getElementById('prev-week').onclick = () => {
    currentWeek--;
    updateWeekDisplay();
    if (selectedRoom) showReservationTable();
  };
  
  document.getElementById('next-week').onclick = () => {
    currentWeek++;
    updateWeekDisplay();
    if (selectedRoom) showReservationTable();
  };
  
  // تغيير القاعة
  document.getElementById('room-select').onchange = function() {
    selectedRoom = this.value;
    if (selectedRoom) {
      showReservationTable();
    } else {
      document.getElementById('reservation-table').style.display = 'none';
      document.getElementById('room-warning').style.display = 'block';
      document.getElementById('room-warning').textContent = '⚠️ يرجى اختيار قاعة لعرض جدول الحجوزات';
    }
  };
  
  // تغيير تاريخ الأسبوع
  document.getElementById('week-date').onchange = function() {
    const selectedDate = new Date(this.value);
    const today = new Date();
    const diffTime = selectedDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    currentWeek = Math.floor(diffDays / 7);
    updateWeekDisplay();
    if (selectedRoom) showReservationTable();
  };
  
  // تصدير البيانات
  document.getElementById('export-btn').onclick = exportData;
});

// إظهار زر القائمة في الشاشات الصغيرة وتثبيت موقعه في أعلى يسار الصفحة
function toggleMenuButton() {
	var btn = document.getElementById('menu-toggle');
	var nav = document.getElementById('nav-links');
	btn.style.position = 'fixed';
	btn.style.left = '18px';
	btn.style.top = '18px';
	btn.style.zIndex = '1100';
	if(window.innerWidth <= 768) {
		btn.style.display = 'block';
		nav.style.position = 'absolute';
		nav.style.top = '60px';
		nav.style.left = '50%';
		nav.style.transform = 'translateX(-50%)';
		nav.style.width = '90vw';
		nav.style.maxWidth = '320px';
		nav.style.background = '#fff';
		nav.style.boxShadow = '0 2px 12px #1b376722';
		nav.style.borderRadius = '12px';
		nav.style.zIndex = '1000';
	} else {
		btn.style.display = 'none';
		nav.style.position = '';
		nav.style.top = '';
		nav.style.left = '';
		nav.style.transform = '';
		nav.style.width = '';
		nav.style.maxWidth = '';
		nav.style.background = 'rgba(27,55,103,0.12)';
		nav.style.boxShadow = '0 2px 12px rgba(27,55,103,0.08)';
		nav.style.borderRadius = '16px';
		nav.style.zIndex = '';
		nav.classList.remove('show');
	}
}
window.addEventListener('resize', toggleMenuButton);
window.addEventListener('DOMContentLoaded', toggleMenuButton);
</script>
</body>
<footer style="background:rgba(27,55,103,0.08); color:#1b3767; text-align:center; padding:18px 0; font-size:1.1em; font-family:'Times New Roman', Times, serif; margin-top:40px; border-radius:0 0 16px 16px;">
	مصممة الموقع : وفاء الشعيلية &mdash; معلمة تقنية معلومات
</footer>
</html>
