<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الحجوزات</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Arabic+Poetry:opsz,wght@16..72,400;16..72,700&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar">
	<div class="corner-logos">
		<img class="logo-ministry" src="https://i.ibb.co/HfwV7QB5/ministerylogo1-1.png" alt="شعار وزارة التربية والتعليم سلطنة عمان">
	</div>
</nav>

<main class="container">
		<div class="site-title-bar" style="text-align:center; margin: 40px auto 0 auto;">
					<span class="site-title">زاوية</span>
					<button id="menu-toggle" style="display:none; background:none; border:none; position:absolute; left:18px; top:18px; z-index:1100; cursor:pointer;">
				<span style="font-size:1.5em; color:#1b3767;">&#9776;</span>
					</button>
					<ul class="nav-links" id="nav-links" style="display:flex; justify-content:center; gap:32px; list-style:none; margin:28px auto 0 auto; padding:0; background:rgba(27,55,103,0.12); border-radius:16px; box-shadow:0 2px 12px rgba(27,55,103,0.08);">
			<li><a href="index.html" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">الرئيسية</a></li>
			<li><a href="reservations.html" class="active" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">الحجوزات</a></li>
			<li><a href="rooms.html" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">القاعات</a></li>
			</ul>
		</div>

<main class="container">
	<h1 class="main-title">زاوية</h1>

<h2>الحجوزات</h2>
<div id="week-controls" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
		<button id="prev-week">الأسبوع السابق</button>
		<span id="week-range" style="font-weight: bold;"></span>
		<button id="next-week">الأسبوع التالي</button>
		<label style="margin-right:20px;">تحديد بداية الأسبوع: <input type="date" id="week-date"></label>
</div>

<label for="room-select">اختر القاعة أولاً:</label>
<select id="room-select">
<option value="">-- اختر القاعة --</option>
</select>

<div id="room-warning" style="display:none;color:#b52b2b;background:#ffeaea;padding:10px 20px;margin:10px 0 0 0;border-radius:7px;font-weight:bold;text-align:center;"></div>
<table id="reservation-table" style="display:none; margin-top:20px;">
<thead>
<tr>
<th>اليوم والتاريخ</th>
<th>الفترة الأولى</th>
<th>الفترة الثانية</th>
<th>الفترة الثالثة</th>
<th>الفترة الرابعة</th>
<th>الفترة الخامسة</th>
<th>الفترة السادسة</th>
<th>الفترة السابعة</th>
<th>النشاط</th>
<th>الطابور</th>
</tr>
</thead>
<tbody>
<tr><td class="day-cell" data-date="0">الأحد <span class="date-span"></span></td><td data-time="sun-1"></td><td data-time="sun-2"></td><td data-time="sun-3"></td><td data-time="sun-4"></td><td data-time="sun-5"></td><td data-time="sun-6"></td><td data-time="sun-7"></td><td data-time="sun-activity"></td><td data-time="sun-assembly"></td></tr>
<tr><td class="day-cell" data-date="1">الإثنين <span class="date-span"></span></td><td data-time="mon-1"></td><td data-time="mon-2"></td><td data-time="mon-3"></td><td data-time="mon-4"></td><td data-time="mon-5"></td><td data-time="mon-6"></td><td data-time="mon-7"></td><td data-time="mon-activity"></td><td data-time="mon-assembly"></td></tr>
<tr><td class="day-cell" data-date="2">الثلاثاء <span class="date-span"></span></td><td data-time="tue-1"></td><td data-time="tue-2"></td><td data-time="tue-3"></td><td data-time="tue-4"></td><td data-time="tue-5"></td><td data-time="tue-6"></td><td data-time="tue-7"></td><td data-time="tue-activity"></td><td data-time="tue-assembly"></td></tr>
<tr><td class="day-cell" data-date="3">الأربعاء <span class="date-span"></span></td><td data-time="wed-1"></td><td data-time="wed-2"></td><td data-time="wed-3"></td><td data-time="wed-4"></td><td data-time="wed-5"></td><td data-time="wed-6"></td><td data-time="wed-7"></td><td data-time="wed-activity"></td><td data-time="wed-assembly"></td></tr>
<tr><td class="day-cell" data-date="4">الخميس <span class="date-span"></span></td><td data-time="thu-1"></td><td data-time="thu-2"></td><td data-time="thu-3"></td><td data-time="thu-4"></td><td data-time="thu-5"></td><td data-time="thu-6"></td><td data-time="thu-7"></td><td data-time="thu-activity"></td><td data-time="thu-assembly"></td></tr>
</tbody>
</table>

<button id="export-btn" class="export-btn">⬇ تصدير الإحصائيات</button>
</main>

<script src="script.js"></script>
<script>
// نظام الحجوزات
let currentWeek = 0;
let selectedRoom = null;
let reservations = [];

// تحميل البيانات من localStorage
function loadData() {
  // تحميل القاعات
  const savedRooms = localStorage.getItem('school_rooms');
  const rooms = savedRooms ? JSON.parse(savedRooms) : ['المختبر', 'قاعة الحاسوب', 'المكتبة', 'القاعة الرئيسية'];
  
  // ملء قائمة القاعات
  const roomSelect = document.getElementById('room-select');
  roomSelect.innerHTML = '<option value="">-- اختر القاعة --</option>';
  rooms.forEach(room => {
    const option = document.createElement('option');
    option.value = room;
    option.textContent = room;
    roomSelect.appendChild(option);
  });
  
  // تحميل الحجوزات
  const savedReservations = localStorage.getItem('school_reservations');
  reservations = savedReservations ? JSON.parse(savedReservations) : [];
}

// حفظ الحجوزات
function saveReservations() {
  localStorage.setItem('school_reservations', JSON.stringify(reservations));
}

// حساب تواريخ الأسبوع
function getWeekDates(weekOffset = 0) {
  const today = new Date();
  const currentDay = today.getDay(); // 0 = أحد, 1 = إثنين, إلخ
  const sunday = new Date(today);
  sunday.setDate(today.getDate() - currentDay + (weekOffset * 7));
  
  const dates = [];
  for (let i = 0; i < 5; i++) { // أحد إلى خميس
    const date = new Date(sunday);
    date.setDate(sunday.getDate() + i);
    dates.push(date);
  }
  return dates;
}

// تحديث عرض الأسبوع
function updateWeekDisplay() {
  const dates = getWeekDates(currentWeek);
  const weekRangeSpan = document.getElementById('week-range');
  
  const startDate = dates[0].toLocaleDateString('ar-SA');
  const endDate = dates[4].toLocaleDateString('ar-SA');
  weekRangeSpan.textContent = `${startDate} - ${endDate}`;
  
  // تحديث تواريخ الأيام في الجدول
  const daySpans = document.querySelectorAll('.date-span');
  daySpans.forEach((span, index) => {
    if (dates[index]) {
      span.textContent = dates[index].toLocaleDateString('ar-SA', {
        month: 'numeric',
        day: 'numeric'
      });
    }
  });
  
  // تحديث حقل التاريخ
  document.getElementById('week-date').value = dates[0].toISOString().split('T')[0];
}

// عرض جدول الحجوزات
function showReservationTable() {
  if (!selectedRoom) return;
  
  document.getElementById('room-warning').style.display = 'none';
  document.getElementById('reservation-table').style.display = 'table';
  
  // مسح الحجوزات السابقة
  const cells = document.querySelectorAll('td[data-time]');
  cells.forEach(cell => {
    cell.innerHTML = '';
    cell.style.backgroundColor = '';
    cell.style.cursor = 'pointer';
    cell.onclick = () => bookSlot(cell);
  });
  
  // عرض الحجوزات الحالية
  const weekDates = getWeekDates(currentWeek);
  reservations.forEach(reservation => {
    if (reservation.room === selectedRoom) {
      const reservationDate = new Date(reservation.date);
      const dayIndex = weekDates.findIndex(date => 
        date.toDateString() === reservationDate.toDateString()
      );
      
      if (dayIndex !== -1) {
        const cell = document.querySelector(`td[data-time="${reservation.timeSlot}"]`);
        if (cell) {
          cell.innerHTML = `
            <div style="background: #e3f2fd; padding: 5px; border-radius: 3px; font-size: 0.85em;">
              <div style="font-weight: bold; color: #1565c0;">${reservation.teacher}</div>
              <div style="color: #1976d2;">${reservation.subject}</div>
              <button onclick="cancelReservation('${reservation.id}')" 
                      style="background: #f44336; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7em; margin-top: 3px; cursor: pointer;">
                إلغاء
              </button>
            </div>
          `;
          cell.style.backgroundColor = '#f3e5f5';
          cell.onclick = null;
        }
      }
    }
  });
}

// حجز فترة زمنية
function bookSlot(cell) {
  if (cell.innerHTML.trim()) return; // محجوز بالفعل
  
  const teacher = prompt('اسم المعلم/المعلمة:');
  if (!teacher) return;
  
  const subject = prompt('اسم المادة أو النشاط:');
  if (!subject) return;
  
  const timeSlot = cell.getAttribute('data-time');
  const weekDates = getWeekDates(currentWeek);
  
  // تحديد التاريخ حسب اليوم
  let dayIndex;
  if (timeSlot.startsWith('sun')) dayIndex = 0;
  else if (timeSlot.startsWith('mon')) dayIndex = 1;
  else if (timeSlot.startsWith('tue')) dayIndex = 2;
  else if (timeSlot.startsWith('wed')) dayIndex = 3;
  else if (timeSlot.startsWith('thu')) dayIndex = 4;
  
  const reservation = {
    id: Date.now().toString(),
    room: selectedRoom,
    teacher: teacher,
    subject: subject,
    timeSlot: timeSlot,
    date: weekDates[dayIndex].toISOString(),
    createdAt: new Date().toISOString()
  };
  
  reservations.push(reservation);
  saveReservations();
  showReservationTable();
  
  alert(`✅ تم حجز القاعة بنجاح!\nالمعلم: ${teacher}\nالمادة: ${subject}`);
}

// إلغاء حجز
function cancelReservation(reservationId) {
  if (confirm('هل أنت متأكد من إلغاء هذا الحجز؟')) {
    reservations = reservations.filter(r => r.id !== reservationId);
    saveReservations();
    showReservationTable();
    alert('✅ تم إلغاء الحجز بنجاح');
  }
}

// تصدير البيانات
function exportData() {
  if (!selectedRoom) {
    alert('⚠️ يرجى اختيار قاعة أولاً');
    return;
  }
  
  const roomReservations = reservations.filter(r => r.room === selectedRoom);
  const csvContent = "data:text/csv;charset=utf-8," + 
    "التاريخ,اليوم,الفترة,المعلم,المادة\n" +
    roomReservations.map(r => {
      const date = new Date(r.date);
      const dayName = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'][date.getDay()];
      return `${date.toLocaleDateString('ar-SA')},${dayName},${r.timeSlot},${r.teacher},${r.subject}`;
    }).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `حجوزات_${selectedRoom}_${new Date().toLocaleDateString('ar-SA')}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// تهيئة النظام
document.addEventListener('DOMContentLoaded', function() {
  loadData();
  updateWeekDisplay();
  
  // أحداث التحكم في الأسبوع
  document.getElementById('prev-week').onclick = () => {
    currentWeek--;
    updateWeekDisplay();
    if (selectedRoom) showReservationTable();
  };
  
  document.getElementById('next-week').onclick = () => {
    currentWeek++;
    updateWeekDisplay();
    if (selectedRoom) showReservationTable();
  };
  
  // تغيير القاعة
  document.getElementById('room-select').onchange = function() {
    selectedRoom = this.value;
    if (selectedRoom) {
      showReservationTable();
    } else {
      document.getElementById('reservation-table').style.display = 'none';
      document.getElementById('room-warning').style.display = 'block';
      document.getElementById('room-warning').textContent = '⚠️ يرجى اختيار قاعة لعرض جدول الحجوزات';
    }
  };
  
  // تغيير تاريخ الأسبوع
  document.getElementById('week-date').onchange = function() {
    const selectedDate = new Date(this.value);
    const today = new Date();
    const diffTime = selectedDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    currentWeek = Math.floor(diffDays / 7);
    updateWeekDisplay();
    if (selectedRoom) showReservationTable();
  };
  
  // تصدير البيانات
  document.getElementById('export-btn').onclick = exportData;
});

// إظهار زر القائمة في الشاشات الصغيرة وتثبيت موقعه في أعلى يسار الصفحة
function toggleMenuButton() {
	var btn = document.getElementById('menu-toggle');
	var nav = document.getElementById('nav-links');
	btn.style.position = 'fixed';
	btn.style.left = '18px';
	btn.style.top = '18px';
	btn.style.zIndex = '1100';
	if(window.innerWidth <= 768) {
		btn.style.display = 'block';
		nav.style.position = 'absolute';
		nav.style.top = '60px';
		nav.style.left = '50%';
		nav.style.transform = 'translateX(-50%)';
		nav.style.width = '90vw';
		nav.style.maxWidth = '320px';
		nav.style.background = '#fff';
		nav.style.boxShadow = '0 2px 12px #1b376722';
		nav.style.borderRadius = '12px';
		nav.style.zIndex = '1000';
	} else {
		btn.style.display = 'none';
		nav.style.position = '';
		nav.style.top = '';
		nav.style.left = '';
		nav.style.transform = '';
		nav.style.width = '';
		nav.style.maxWidth = '';
		nav.style.background = 'rgba(27,55,103,0.12)';
		nav.style.boxShadow = '0 2px 12px rgba(27,55,103,0.08)';
		nav.style.borderRadius = '16px';
		nav.style.zIndex = '';
		nav.classList.remove('show');
	}
}
window.addEventListener('resize', toggleMenuButton);
window.addEventListener('DOMContentLoaded', toggleMenuButton);
</script>
</body>
<footer style="background:rgba(27,55,103,0.08); color:#1b3767; text-align:center; padding:18px 0; font-size:1.1em; font-family:'Times New Roman', Times, serif; margin-top:40px; border-radius:0 0 16px 16px;">
	مصممة الموقع : وفاء الشعيلية &mdash; معلمة تقنية معلومات
</footer>
</html>
