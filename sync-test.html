<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1b3767;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #218838;
        }
        button.test {
            background: #17a2b8;
        }
        button.test:hover {
            background: #138496;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        .links a {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
        }
        .links a:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª</h1>
        
        <div class="links">
            <a href="rooms.html" target="_blank">ğŸ¢ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</a>
            <a href="reservations.html" target="_blank">ğŸ“… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</a>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
            <button class="test" onclick="testAddRoom()">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© Ø§Ø®ØªØ¨Ø§Ø±</button>
            <button class="test" onclick="testStorageEvent()">Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø¯Ø« Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>
            <button class="test" onclick="testCustomEvent()">Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ù…Ø®ØµØµ</button>
            <button onclick="clearLog()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
            <button onclick="showCurrentRooms()">Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div id="status"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let eventCounter = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const logDiv = document.getElementById('log');
            const color = {
                'info': '#3498db',
                'success': '#2ecc71',
                'warning': '#f39c12',
                'error': '#e74c3c'
            }[type] || '#ecf0f1';
            
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', 'info');
        }

        function showCurrentRooms() {
            const rooms = localStorage.getItem('school_rooms');
            if (rooms) {
                try {
                    const parsed = JSON.parse(rooms);
                    log(`Ø§Ù„Ù‚Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${Array.isArray(parsed) ? parsed.length : 'ÙƒØ§Ø¦Ù†'}): ${JSON.stringify(parsed, null, 2)}`, 'info');
                } catch (e) {
                    log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`, 'error');
                }
            } else {
                log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©', 'warning');
            }
            updateStatus();
        }

        function testAddRoom() {
            eventCounter++;
            const testRoomName = `Ù‚Ø§Ø¹Ø© Ø§Ø®ØªØ¨Ø§Ø± ${eventCounter}`;
            
            log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ©: ${testRoomName}`, 'info');
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø©
            let currentRooms = [];
            const saved = localStorage.getItem('school_rooms');
            
            if (saved) {
                try {
                    currentRooms = JSON.parse(saved);
                    if (!Array.isArray(currentRooms)) {
                        currentRooms = Object.values(currentRooms).map(r => typeof r === 'string' ? r : r.name);
                    }
                } catch (e) {
                    log(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`, 'error');
                    return;
                }
            }
            
            currentRooms.push(testRoomName);
            localStorage.setItem('school_rooms', JSON.stringify(currentRooms));
            
            log(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¹Ø© Ù…Ø­Ù„ÙŠØ§Ù‹: ${testRoomName}`, 'success');
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            testStorageEvent();
            testCustomEvent(testRoomName);
        }

        function testStorageEvent() {
            log('Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« ØªØ®Ø²ÙŠÙ† (storage event)...', 'info');
            
            const rooms = localStorage.getItem('school_rooms');
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'school_rooms',
                newValue: rooms,
                oldValue: null,
                storageArea: localStorage,
                url: window.location.href
            }));
            
            log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ø§Ù„ØªØ®Ø²ÙŠÙ†', 'success');
        }

        function testCustomEvent(roomName = 'Ù‚Ø§Ø¹Ø© Ø§Ø®ØªØ¨Ø§Ø±') {
            log('Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ù…Ø®ØµØµ (custom event)...', 'info');
            
            window.dispatchEvent(new CustomEvent('roomsUpdated', {
                detail: { 
                    action: 'add', 
                    roomName: roomName, 
                    source: 'test',
                    timestamp: new Date().toISOString() 
                }
            }));
            
            log(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ù…Ø®ØµØµ Ù„Ù„Ù‚Ø§Ø¹Ø©: ${roomName}`, 'success');
        }

        function updateStatus() {
            const rooms = localStorage.getItem('school_rooms');
            const reservations = localStorage.getItem('school_reservations');
            
            let statusHtml = '<h4>ğŸ“Š Ø­Ø§Ù„Ø© localStorage:</h4>';
            statusHtml += `<p><strong>school_rooms:</strong> ${rooms ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}</p>`;
            statusHtml += `<p><strong>school_reservations:</strong> ${reservations ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}</p>`;
            
            if (rooms) {
                try {
                    const parsed = JSON.parse(rooms);
                    const count = Array.isArray(parsed) ? parsed.length : Object.keys(parsed).length;
                    statusHtml += `<p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª:</strong> ${count}</p>`;
                } catch (e) {
                    statusHtml += `<p style="color: red;"><strong>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong> ${e.message}</p>`;
                }
            }
            
            document.getElementById('status').innerHTML = statusHtml;
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        window.addEventListener('storage', function(e) {
            if (e.key === 'school_rooms') {
                log(`ğŸ”” ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« ØªØ®Ø²ÙŠÙ†: ${e.key}`, 'warning');
            }
        });

        window.addEventListener('roomsUpdated', function(e) {
            log(`ğŸ”” ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« Ù…Ø®ØµØµ: ${JSON.stringify(e.detail)}`, 'warning');
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            log('ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù†', 'info');
            updateStatus();
        };
    </script>
</body>
</html>