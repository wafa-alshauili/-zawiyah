<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار تكامل صفحة القاعات</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            color: #1b3767;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .test-section h3 {
            color: #1b3767;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #1b3767;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2c5282;
        }
        #testResults {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 اختبار تكامل صفحة القاعات مع النظام المختلط</h1>
            <p>اختبار شامل لتكامل dataManager و Firebase مع صفحة القاعات</p>
        </div>

        <div class="test-section">
            <h3>🔧 التحقق من الأنظمة</h3>
            <button onclick="checkSystems()">فحص الأنظمة</button>
            <div id="systemStatus"></div>
        </div>

        <div class="test-section">
            <h3>📝 اختبار عمليات القاعات</h3>
            <button onclick="testAddRoom()">اختبار إضافة قاعة</button>
            <button onclick="testLoadRooms()">اختبار تحميل القاعات</button>
            <button onclick="testDeleteRoom()">اختبار حذف قاعة</button>
            <button onclick="testSync()">اختبار المزامنة</button>
            <div id="roomOperationsStatus"></div>
        </div>

        <div class="test-section">
            <h3>🌐 اختبار الاتصال</h3>
            <button onclick="testOnlineMode()">اختبار الوضع المتصل</button>
            <button onclick="testOfflineMode()">اختبار الوضع غير المتصل</button>
            <div id="connectionStatus"></div>
        </div>

        <div class="test-section">
            <h3>📊 النتائج التفصيلية</h3>
            <button onclick="runAllTests()">تشغيل جميع الاختبارات</button>
            <button onclick="clearResults()">مسح النتائج</button>
            <div id="testResults"></div>
        </div>
    </div>

    <!-- تضمين Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- تضمين ملفات النظام -->
    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEtKG8",
            authDomain: "zawiyah-76151.firebaseapp.com",
            projectId: "zawiyah-76151",
            storageBucket: "zawiyah-76151.firebasestorage.app",
            messagingSenderId: "333165441127",
            appId: "1:333165441127:web:ba2b3d3c39807ac788357c"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
    </script>
    <script src="dataManager.js"></script>

    <script>
        let testResults = [];

        function logResult(test, status, message) {
            const result = {
                test,
                status,
                message,
                timestamp: new Date().toLocaleString('ar-SA')
            };
            testResults.push(result);
            displayResults();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.map(result => `
                <div class="status ${result.status}">
                    <strong>[${result.timestamp}] ${result.test}:</strong> ${result.message}
                </div>
            `).join('');
        }

        async function checkSystems() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="status info">جاري فحص الأنظمة...</div>';

            let html = '';

            // فحص Firebase
            try {
                await db.collection('test').limit(1).get();
                html += '<div class="status success">✅ Firebase متصل ويعمل بشكل طبيعي</div>';
                logResult('فحص Firebase', 'success', 'الاتصال ناجح');
            } catch (error) {
                html += '<div class="status error">❌ خطأ في الاتصال بـ Firebase: ' + error.message + '</div>';
                logResult('فحص Firebase', 'error', error.message);
            }

            // فحص dataManager
            if (window.dataManager) {
                html += '<div class="status success">✅ dataManager متاح</div>';
                if (window.dataManager.initialized) {
                    html += '<div class="status success">✅ dataManager مهيئ</div>';
                    logResult('فحص dataManager', 'success', 'النظام مهيئ ومتاح');
                } else {
                    html += '<div class="status info">⚠️ dataManager في طور التهيئة</div>';
                    logResult('فحص dataManager', 'info', 'في طور التهيئة');
                }
            } else {
                html += '<div class="status error">❌ dataManager غير متاح</div>';
                logResult('فحص dataManager', 'error', 'غير متاح');
            }

            // فحص localStorage
            try {
                localStorage.setItem('test_key', 'test_value');
                const testValue = localStorage.getItem('test_key');
                if (testValue === 'test_value') {
                    html += '<div class="status success">✅ localStorage يعمل بشكل طبيعي</div>';
                    localStorage.removeItem('test_key');
                    logResult('فحص localStorage', 'success', 'يعمل بشكل طبيعي');
                } else {
                    throw new Error('قيمة غير صحيحة');
                }
            } catch (error) {
                html += '<div class="status error">❌ خطأ في localStorage: ' + error.message + '</div>';
                logResult('فحص localStorage', 'error', error.message);
            }

            statusDiv.innerHTML = html;
        }

        async function testAddRoom() {
            const statusDiv = document.getElementById('roomOperationsStatus');
            statusDiv.innerHTML = '<div class="status info">جاري اختبار إضافة قاعة...</div>';

            try {
                const testRoomName = 'قاعة اختبار ' + Date.now();
                
                // محاولة إضافة قاعة
                if (window.dataManager) {
                    const currentRooms = await dataManager.getData('school_rooms', []);
                    const newRooms = [...currentRooms, testRoomName];
                    await dataManager.saveData('school_rooms', newRooms);
                    
                    // التحقق من الحفظ
                    const savedRooms = await dataManager.getData('school_rooms', []);
                    if (savedRooms.includes(testRoomName)) {
                        statusDiv.innerHTML = '<div class="status success">✅ تم إضافة القاعة بنجاح: ' + testRoomName + '</div>';
                        logResult('إضافة قاعة', 'success', 'تمت إضافة: ' + testRoomName);
                    } else {
                        throw new Error('فشل في التحقق من الحفظ');
                    }
                } else {
                    throw new Error('dataManager غير متاح');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ خطأ في إضافة القاعة: ' + error.message + '</div>';
                logResult('إضافة قاعة', 'error', error.message);
            }
        }

        async function testLoadRooms() {
            const statusDiv = document.getElementById('roomOperationsStatus');
            statusDiv.innerHTML = '<div class="status info">جاري اختبار تحميل القاعات...</div>';

            try {
                if (window.dataManager) {
                    const rooms = await dataManager.getData('school_rooms', []);
                    statusDiv.innerHTML = '<div class="status success">✅ تم تحميل ' + rooms.length + ' قاعة بنجاح</div>';
                    logResult('تحميل قاعات', 'success', 'تم تحميل ' + rooms.length + ' قاعة');
                } else {
                    throw new Error('dataManager غير متاح');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ خطأ في تحميل القاعات: ' + error.message + '</div>';
                logResult('تحميل قاعات', 'error', error.message);
            }
        }

        async function testDeleteRoom() {
            const statusDiv = document.getElementById('roomOperationsStatus');
            statusDiv.innerHTML = '<div class="status info">جاري اختبار حذف قاعة...</div>';

            try {
                if (window.dataManager) {
                    let rooms = await dataManager.getData('school_rooms', []);
                    const testRooms = rooms.filter(room => room.includes('قاعة اختبار'));
                    
                    if (testRooms.length > 0) {
                        const roomToDelete = testRooms[0];
                        const filteredRooms = rooms.filter(room => room !== roomToDelete);
                        await dataManager.saveData('school_rooms', filteredRooms);
                        
                        // التحقق من الحذف
                        const updatedRooms = await dataManager.getData('school_rooms', []);
                        if (!updatedRooms.includes(roomToDelete)) {
                            statusDiv.innerHTML = '<div class="status success">✅ تم حذف القاعة بنجاح: ' + roomToDelete + '</div>';
                            logResult('حذف قاعة', 'success', 'تم حذف: ' + roomToDelete);
                        } else {
                            throw new Error('فشل في التحقق من الحذف');
                        }
                    } else {
                        statusDiv.innerHTML = '<div class="status info">ℹ️ لا توجد قاعات اختبار للحذف</div>';
                        logResult('حذف قاعة', 'info', 'لا توجد قاعات اختبار');
                    }
                } else {
                    throw new Error('dataManager غير متاح');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ خطأ في حذف القاعة: ' + error.message + '</div>';
                logResult('حذف قاعة', 'error', error.message);
            }
        }

        async function testSync() {
            const statusDiv = document.getElementById('roomOperationsStatus');
            statusDiv.innerHTML = '<div class="status info">جاري اختبار المزامنة...</div>';

            try {
                if (window.dataManager && window.dataManager.forceSyncAll) {
                    await dataManager.forceSyncAll();
                    statusDiv.innerHTML = '<div class="status success">✅ تمت المزامنة بنجاح</div>';
                    logResult('مزامنة البيانات', 'success', 'تمت المزامنة بنجاح');
                } else {
                    throw new Error('دالة المزامنة غير متاحة');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ خطأ في المزامنة: ' + error.message + '</div>';
                logResult('مزامنة البيانات', 'error', error.message);
            }
        }

        async function testOnlineMode() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<div class="status info">جاري اختبار الوضع المتصل...</div>';

            try {
                // محاولة الوصول لـ Firebase
                const testDoc = await db.collection('test').doc('connection-test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'online-mode'
                });
                
                statusDiv.innerHTML = '<div class="status success">✅ الوضع المتصل يعمل بشكل طبيعي</div>';
                logResult('الوضع المتصل', 'success', 'اتصال Firebase نشط');
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ خطأ في الوضع المتصل: ' + error.message + '</div>';
                logResult('الوضع المتصل', 'error', error.message);
            }
        }

        async function testOfflineMode() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<div class="status info">جاري اختبار الوضع غير المتصل...</div>';

            try {
                // اختبار العمل مع localStorage فقط
                const testData = ['قاعة اختبار أوفلاين'];
                localStorage.setItem('offline_test_rooms', JSON.stringify(testData));
                
                const retrievedData = JSON.parse(localStorage.getItem('offline_test_rooms') || '[]');
                if (JSON.stringify(retrievedData) === JSON.stringify(testData)) {
                    statusDiv.innerHTML = '<div class="status success">✅ الوضع غير المتصل يعمل بشكل طبيعي</div>';
                    localStorage.removeItem('offline_test_rooms');
                    logResult('الوضع غير المتصل', 'success', 'localStorage يعمل بشكل طبيعي');
                } else {
                    throw new Error('فشل في تخزين أو استرداد البيانات');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ خطأ في الوضع غير المتصل: ' + error.message + '</div>';
                logResult('الوضع غير المتصل', 'error', error.message);
            }
        }

        async function runAllTests() {
            logResult('بدء الاختبارات', 'info', 'تشغيل جميع الاختبارات الشاملة');
            
            await checkSystems();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testLoadRooms();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAddRoom();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDeleteRoom();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSync();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testOnlineMode();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testOfflineMode();
            
            logResult('انتهاء الاختبارات', 'success', 'تم تشغيل جميع الاختبارات بنجاح');
        }

        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('systemStatus').innerHTML = '';
            document.getElementById('roomOperationsStatus').innerHTML = '';
            document.getElementById('connectionStatus').innerHTML = '';
        }

        // تشغيل فحص أولي عند تحميل الصفحة
        window.addEventListener('load', () => {
            setTimeout(checkSystems, 1000);
        });
    </script>
</body>
</html>