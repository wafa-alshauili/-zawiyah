<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الزاوية</title>
<link rel="stylesheet" href="style.css">
<!-- مكتبة Chart.js للرسوم البيانية -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar">
  <div class="corner-logos">
    <img class="logo-ministry" src="https://i.ibb.co/HfwV7QB5/ministerylogo1-1.png" alt="شعار وزارة التربية والتعليم سلطنة عمان">
  </div>
</nav>
  <main class="container">
  <div class="site-title-bar" style="text-align:center; margin: 40px auto 0 auto;">
  <span class="site-title">زاوية</span>
  <hr id="responsive-title-hr" style="display:none; border:none; border-bottom:2.5px solid #1b3767; width:70%; margin:12px auto 0 auto;">
    <button id="menu-toggle" style="display:none; background:none; border:none; position:absolute; left:18px; top:18px; z-index:1100; cursor:pointer;">
      <span style="font-size:1.5em; color:#1b3767;">&#9776;</span>
    </button>
    <ul class="nav-links" id="nav-links" style="display:flex; justify-content:center; gap:32px; list-style:none; margin:28px auto 0 auto; padding:0; background:rgba(27,55,103,0.12); border-radius:16px; box-shadow:0 2px 12px rgba(27,55,103,0.08);">
      <li><a href="index.html" class="active" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px; border-bottom: 5px solid #0d2546; box-shadow: 0 4px 0 #0d2546;">الرئيسية</a></li>
      <li><a href="reservations.html" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">الحجوزات</a></li>
      <li><a href="rooms.html" style="font-size:1.2em; font-family:'Times New Roman', Times, serif; color:#1b3767; font-weight:bold; padding:10px 24px; border-radius:8px;">القاعات</a></li>
    </ul>
  </div>
  <div class="welcome-box" style="text-align:center; margin: 18px auto 32px auto; max-width: 500px; background: #fafdff; border-radius: 12px; box-shadow: 0 2px 12px #dbe3f7; padding: 18px 22px;">
  <p style="font-size:1.15em; color:#1b3767; margin-bottom:10px;">مرحبًا بك في منصة زاوية لحجز القاعات المدرسية!</p>
  <p style="font-size:1em; color:#254a8a; margin-bottom:18px;">يهدف الموقع إلى تسهيل عملية حجز القاعات وإدارتها إلكترونيًا في <br>مدرسة بسياء للتعليم الأساسي (5-12) مع توفير تجربة سهلة لجميع المستخدمين في بيئة تعليمية متكاملة.</p>
    <button onclick="window.location.href='reservations.html'" style="background:#1b3767; color:#fff; border:none; border-radius:7px; padding:10px 28px; font-size:1.1em; font-weight:bold; cursor:pointer; box-shadow:0 2px 8px #dbe3f7;">الانتقال إلى صفحة الحجوزات</button>
  </div>

  <!-- لوحة التحكم والإحصائيات -->
  <div class="dashboard" style="margin: 30px auto; max-width: 800px;">
    <h2 style="text-align: center; color: #1b3767; margin-bottom: 25px;">📊 لوحة التحكم</h2>
    
    <!-- بطاقات الإحصائيات -->
    <div class="stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div class="stat-card" style="background: #e3f2fd; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5em; color: #1976d2; margin-bottom: 10px;">🏢</div>
        <div style="font-size: 1.8em; font-weight: bold; color: #1976d2;" id="total-rooms">0</div>
        <div style="color: #555; margin-top: 5px;">إجمالي القاعات</div>
      </div>
      
      <div class="stat-card" style="background: #e8f5e8; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5em; color: #4caf50; margin-bottom: 10px;">📅</div>
        <div style="font-size: 1.8em; font-weight: bold; color: #4caf50;" id="total-reservations">0</div>
        <div style="color: #555; margin-top: 5px;">إجمالي الحجوزات</div>
      </div>
      
      <div class="stat-card" style="background: #fff3e0; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5em; color: #ff9800; margin-bottom: 10px;">📈</div>
        <div style="font-size: 1.8em; font-weight: bold; color: #ff9800;" id="this-week-reservations">0</div>
        <div style="color: #555; margin-top: 5px;">حجوزات هذا الأسبوع</div>
      </div>
    </div>

    <!-- الروابط السريعة -->
    <div class="quick-actions" style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h3 style="color: #1b3767; margin-bottom: 20px; text-align: center;">⚡ الإجراءات السريعة</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <button onclick="window.location.href='reservations.html'" 
                style="background: #1b3767; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s;">
          📅 حجز قاعة جديدة
        </button>
        <button onclick="window.location.href='rooms.html'" 
                style="background: #4caf50; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s;">
          🏢 إدارة القاعات
        </button>
        <button onclick="exportAllData()" 
                style="background: #ff9800; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s;">
          📊 تصدير البيانات
        </button>
      </div>
    </div>

    <!-- أحدث الحجوزات -->
    <div class="recent-bookings" style="background: white; border-radius: 12px; padding: 25px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h3 style="color: #1b3767; margin-bottom: 20px; text-align: center;">🕒 أحدث الحجوزات</h3>
      <div id="recent-bookings-list" style="max-height: 300px; overflow-y: auto;">
        <div style="text-align: center; color: #666; padding: 20px; font-style: italic;">لا توجد حجوزات حديثة</div>
      </div>
    </div>

    <!-- الإحصائيات البصرية -->
    <div class="visual-stats" style="background: white; border-radius: 12px; padding: 25px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #1b3767; margin: 0;">📊 الإحصائيات البصرية</h3>
        <div>
          <button onclick="exportCharts()" style="background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-left: 10px; cursor: pointer; font-size: 0.9em;">
            📊 تصدير الإحصائيات
          </button>
          <button onclick="printCharts()" style="background: #2196f3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
            🖨️ طباعة الإحصائيات
          </button>
        </div>
      </div>
      
      <div class="charts-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
        <!-- أكثر المعلمات حجزاً -->
        <div class="chart-section">
          <h4 style="color: #1b3767; text-align: center; margin-bottom: 15px;">👩‍🏫 أكثر المعلمات حجزاً</h4>
          <canvas id="teachersChart" style="max-height: 300px;"></canvas>
          <div id="teachersStats" style="margin-top: 15px; font-size: 0.9em; color: #666;"></div>
        </div>
        
        <!-- أكثر القاعات استخداماً -->
        <div class="chart-section">
          <h4 style="color: #1b3767; text-align: center; margin-bottom: 15px;">🏢 أكثر القاعات استخداماً</h4>
          <canvas id="roomsChart" style="max-height: 300px;"></canvas>
          <div id="roomsStats" style="margin-top: 15px; font-size: 0.9em; color: #666;"></div>
        </div>
      </div>

      <!-- إحصائيات إضافية -->
      <div class="additional-stats" style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 1.5em; color: #9c27b0; font-weight: bold;" id="most-active-teacher">--</div>
          <div style="color: #666; font-size: 0.9em;">المعلمة الأكثر نشاطاً</div>
        </div>
        
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 1.5em; color: #4caf50; font-weight: bold;" id="most-popular-room">--</div>
          <div style="color: #666; font-size: 0.9em;">القاعة الأكثر حجزاً</div>
        </div>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 1.5em; color: #2196f3; font-weight: bold;" id="peak-day">--</div>
          <div style="color: #666; font-size: 0.9em;">اليوم الأكثر حجزاً</div>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="script.js"></script>
<script>
// تحديث لوحة التحكم
let teachersChart, roomsChart;

function updateDashboard() {
  // تحميل البيانات
  const savedRooms = localStorage.getItem('school_rooms');
  const rooms = savedRooms ? JSON.parse(savedRooms) : [];
  
  const savedReservations = localStorage.getItem('school_reservations');
  const reservations = savedReservations ? JSON.parse(savedReservations) : [];
  
  // تحديث إجمالي القاعات
  document.getElementById('total-rooms').textContent = rooms.length;
  
  // تحديث إجمالي الحجوزات
  document.getElementById('total-reservations').textContent = reservations.length;
  
  // حساب حجوزات هذا الأسبوع
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  
  const thisWeekReservations = reservations.filter(r => {
    const reservationDate = new Date(r.date);
    return reservationDate >= weekStart && reservationDate <= weekEnd;
  });
  
  document.getElementById('this-week-reservations').textContent = thisWeekReservations.length;
  
  // عرض أحدث الحجوزات
  updateRecentBookings(reservations);
  
  // تحديث الإحصائيات البصرية
  updateVisualStats(reservations);
}

function updateRecentBookings(reservations) {
  const recentBookingsList = document.getElementById('recent-bookings-list');
  if (reservations.length === 0) {
    recentBookingsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; font-style: italic;">لا توجد حجوزات حديثة</div>';
  } else {
    const recentReservations = reservations
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .slice(0, 5);
    
    recentBookingsList.innerHTML = recentReservations.map(r => `
      <div style="border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: bold; color: #1b3767;">${r.room}</div>
          <div style="color: #666; font-size: 0.9em;">${r.teacher} - ${r.subject}</div>
        </div>
        <div style="text-align: right; font-size: 0.85em; color: #888;">
          ${new Date(r.date).toLocaleDateString('ar-SA')}
        </div>
      </div>
    `).join('');
  }
}

function updateVisualStats(reservations) {
  if (reservations.length === 0) {
    // إذا لم توجد حجوزات، عرض رسائل فارغة
    document.getElementById('most-active-teacher').textContent = 'لا توجد بيانات';
    document.getElementById('most-popular-room').textContent = 'لا توجد بيانات';
    document.getElementById('peak-day').textContent = 'لا توجد بيانات';
    return;
  }
  
  // إحصائيات المعلمات
  const teachersStats = {};
  reservations.forEach(r => {
    teachersStats[r.teacher] = (teachersStats[r.teacher] || 0) + 1;
  });
  
  // إحصائيات القاعات
  const roomsStats = {};
  reservations.forEach(r => {
    roomsStats[r.room] = (roomsStats[r.room] || 0) + 1;
  });
  
  // إحصائيات الأيام
  const daysStats = {};
  const dayNames = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
  reservations.forEach(r => {
    const day = dayNames[new Date(r.date).getDay()];
    daysStats[day] = (daysStats[day] || 0) + 1;
  });
  
  // إنشاء الرسوم البيانية
  createTeachersChart(teachersStats);
  createRoomsChart(roomsStats);
  
  // تحديث الإحصائيات الإضافية
  const mostActiveTeacher = Object.keys(teachersStats).reduce((a, b) => teachersStats[a] > teachersStats[b] ? a : b);
  const mostPopularRoom = Object.keys(roomsStats).reduce((a, b) => roomsStats[a] > roomsStats[b] ? a : b);
  const peakDay = Object.keys(daysStats).reduce((a, b) => daysStats[a] > daysStats[b] ? a : b);
  
  document.getElementById('most-active-teacher').textContent = mostActiveTeacher;
  document.getElementById('most-popular-room').textContent = mostPopularRoom;
  document.getElementById('peak-day').textContent = peakDay;
  
  // تحديث النصوص الإحصائية
  document.getElementById('teachersStats').innerHTML = 
    `إجمالي المعلمات النشطات: <strong>${Object.keys(teachersStats).length}</strong>`;
  document.getElementById('roomsStats').innerHTML = 
    `إجمالي القاعات المستخدمة: <strong>${Object.keys(roomsStats).length}</strong>`;
}

function createTeachersChart(teachersStats) {
  const ctx = document.getElementById('teachersChart').getContext('2d');
  
  // تدمير الرسم السابق إن وُجد
  if (teachersChart) {
    teachersChart.destroy();
  }
  
  const sortedTeachers = Object.entries(teachersStats)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 10); // أفضل 10 معلمات
  
  teachersChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedTeachers.map(([teacher]) => teacher),
      datasets: [{
        label: 'عدد الحجوزات',
        data: sortedTeachers.map(([, count]) => count),
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
          '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', 
          '#4BC0C0', '#FF9F40'
        ],
        borderColor: '#1b3767',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

function createRoomsChart(roomsStats) {
  const ctx = document.getElementById('roomsChart').getContext('2d');
  
  // تدمير الرسم السابق إن وُجد
  if (roomsChart) {
    roomsChart.destroy();
  }
  
  const sortedRooms = Object.entries(roomsStats)
    .sort(([,a], [,b]) => b - a);
  
  roomsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: sortedRooms.map(([room]) => room),
      datasets: [{
        data: sortedRooms.map(([, count]) => count),
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
          '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

// تصدير الإحصائيات
function exportCharts() {
  const savedReservations = localStorage.getItem('school_reservations');
  const reservations = savedReservations ? JSON.parse(savedReservations) : [];
  
  if (reservations.length === 0) {
    alert('⚠️ لا توجد بيانات للتصدير');
    return;
  }
  
  // إحصائيات المعلمات
  const teachersStats = {};
  reservations.forEach(r => {
    teachersStats[r.teacher] = (teachersStats[r.teacher] || 0) + 1;
  });
  
  // إحصائيات القاعات
  const roomsStats = {};
  reservations.forEach(r => {
    roomsStats[r.room] = (roomsStats[r.room] || 0) + 1;
  });
  
  // إنشاء CSV للإحصائيات
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "تقرير الإحصائيات - نظام حجز القاعات\n\n";
  csvContent += "إحصائيات المعلمات\n";
  csvContent += "المعلمة,عدد الحجوزات\n";
  
  Object.entries(teachersStats)
    .sort(([,a], [,b]) => b - a)
    .forEach(([teacher, count]) => {
      csvContent += `${teacher},${count}\n`;
    });
  
  csvContent += "\n\nإحصائيات القاعات\n";
  csvContent += "القاعة,عدد الحجوزات\n";
  
  Object.entries(roomsStats)
    .sort(([,a], [,b]) => b - a)
    .forEach(([room, count]) => {
      csvContent += `${room},${count}\n`;
    });
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `إحصائيات_القاعات_${new Date().toLocaleDateString('ar-SA')}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert('✅ تم تصدير الإحصائيات بنجاح!');
}

// طباعة الإحصائيات
function printCharts() {
  const printWindow = window.open('', '_blank');
  const charts = document.querySelector('.visual-stats').innerHTML;
  
  printWindow.document.write(`
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <title>إحصائيات نظام حجز القاعات</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #1b3767; text-align: center; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .chart-section h4 { color: #1b3767; text-align: center; }
        .additional-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .stat-box { background: #f5f5f5; padding: 15px; text-align: center; border-radius: 8px; }
        button { display: none; }
        @media print { body { margin: 0; } }
      </style>
    </head>
    <body>
      <h1>📊 إحصائيات نظام حجز القاعات - مدرسة بسياء</h1>
      <p style="text-align: center; color: #666;">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>
      ${charts}
    </body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.focus();
  
  // انتظار تحميل المحتوى ثم الطباعة
  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 500);
}

// تصدير جميع البيانات
function exportAllData() {
  const savedRooms = localStorage.getItem('school_rooms');
  const rooms = savedRooms ? JSON.parse(savedRooms) : [];
  
  const savedReservations = localStorage.getItem('school_reservations');
  const reservations = savedReservations ? JSON.parse(savedReservations) : [];
  
  if (reservations.length === 0) {
    alert('⚠️ لا توجد بيانات للتصدير');
    return;
  }
  
  const csvContent = "data:text/csv;charset=utf-8," + 
    "التاريخ,اليوم,القاعة,المعلم,المادة,وقت الإنشاء\n" +
    reservations.map(r => {
      const date = new Date(r.date);
      const dayName = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'][date.getDay()];
      const createdDate = new Date(r.createdAt);
      return `${date.toLocaleDateString('ar-SA')},${dayName},${r.room},${r.teacher},${r.subject},${createdDate.toLocaleDateString('ar-SA')}`;
    }).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `تقرير_شامل_${new Date().toLocaleDateString('ar-SA')}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert('✅ تم تصدير البيانات بنجاح!');
}

// تحديث لوحة التحكم عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
  updateDashboard();
  
  // تحديث البيانات كل 5 ثوانٍ في حالة تم التعديل من صفحة أخرى
  setInterval(updateDashboard, 5000);
});

// إظهار زر القائمة في الشاشات الصغيرة وتثبيت موقعه في أعلى يسار الصفحة
function toggleMenuButton() {
  var btn = document.getElementById('menu-toggle');
  var nav = document.getElementById('nav-links');
  var hr = document.getElementById('responsive-title-hr');
  btn.style.position = 'fixed';
  btn.style.left = '18px';
  btn.style.top = '18px';
  btn.style.zIndex = '1100';
  if(window.innerWidth <= 768) {
    btn.style.display = 'block';
    nav.style.position = 'absolute';
    nav.style.top = '60px';
    nav.style.left = '50%';
    nav.style.transform = 'translateX(-50%)';
    nav.style.width = '90vw';
    nav.style.maxWidth = '320px';
    nav.style.background = '#fff';
    nav.style.boxShadow = '0 2px 12px #1b376722';
    nav.style.borderRadius = '12px';
    nav.style.zIndex = '1000';
    hr.style.display = 'block';
  } else {
    btn.style.display = 'none';
    nav.style.position = '';
    nav.style.top = '';
    nav.style.left = '';
    nav.style.transform = '';
    nav.style.width = '';
    nav.style.maxWidth = '';
    nav.style.background = 'rgba(27,55,103,0.12)';
    nav.style.boxShadow = '0 2px 12px rgba(27,55,103,0.08)';
    nav.style.borderRadius = '16px';
    nav.style.zIndex = '';
    nav.classList.remove('show');
    hr.style.display = 'none';
  }
}
window.addEventListener('resize', toggleMenuButton);
window.addEventListener('DOMContentLoaded', toggleMenuButton);
</script>
</body>
<footer style="background:rgba(27,55,103,0.08); color:#1b3767; text-align:center; padding:18px 0; font-size:1.1em; font-family:'Times New Roman', Times, serif; margin-top:40px; border-radius:0 0 16px 16px;">
  مصممة الموقع : وفاء الشعيلية &mdash; معلمة تقنية معلومات<br>
  <span style="font-size:0.98em; color:#254a8a;">الموقع قيد التجربة لذا نرحب بجميع الملاحظات</span>
</footer>
</html>
