<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار مزامنة الحجوزات المتقدم</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .reservation-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #667eea;
            margin: 15px 0;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #667eea;
        }
        .form-group select, .form-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 12px 24px; 
            margin: 8px; 
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .reservation-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .reservation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .reservation-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }
        .reservation-date {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .reservation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .detail-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
            display: block;
            font-size: 12px;
        }
        .stats-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }
        .stats-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #results { 
            background: white; 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin-top: 20px; 
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .sync-active { background: #28a745; }
        .sync-inactive { background: #dc3545; }
        .sync-syncing { background: #ffc107; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>🧪 اختبار مزامنة الحجوزات المتقدم</h1>
            <p>اختبار شامل لنظام الحجوزات مع الدرجات والأقسام والتواريخ</p>
            <div id="sync-status">
                <span class="sync-indicator sync-inactive"></span>
                جاري التحقق من حالة المزامنة...
            </div>
        </div>

        <div class="test-grid">
            <!-- إنشاء حجز جديد -->
            <div class="test-section">
                <h2>📅 إنشاء حجز تجريبي</h2>
                <div class="reservation-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>المادة:</label>
                            <select id="test-subject">
                                <option value="الرياضيات">الرياضيات</option>
                                <option value="العلوم">العلوم</option>
                                <option value="اللغة العربية">اللغة العربية</option>
                                <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                                <option value="الفيزياء">الفيزياء</option>
                                <option value="الكيمياء">الكيمياء</option>
                                <option value="التاريخ">التاريخ</option>
                                <option value="الجغرافيا">الجغرافيا</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>اسم المعلم:</label>
                            <input type="text" id="test-teacher" placeholder="أ. محمد أحمد" value="أ. اختبار النظام">
                        </div>
                        <div class="form-group">
                            <label>الدرجة:</label>
                            <select id="test-grade">
                                <option value="5">الخامس</option>
                                <option value="6">السادس</option>
                                <option value="7">السابع</option>
                                <option value="8">الثامن</option>
                                <option value="9">التاسع</option>
                                <option value="10">العاشر</option>
                                <option value="11">الحادي عشر</option>
                                <option value="12">الثاني عشر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>القسم:</label>
                            <select id="test-section">
                                <option value="أ">أ</option>
                                <option value="ب">ب</option>
                                <option value="ج">ج</option>
                                <option value="د">د</option>
                                <option value="ه">ه</option>
                                <option value="و">و</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>التاريخ:</label>
                            <input type="date" id="test-date" value="">
                        </div>
                        <div class="form-group">
                            <label>الوقت:</label>
                            <select id="test-time">
                                <option value="07:30-08:15">07:30-08:15</option>
                                <option value="08:15-09:00">08:15-09:00</option>
                                <option value="09:00-09:45">09:00-09:45</option>
                                <option value="09:45-10:30">09:45-10:30</option>
                                <option value="11:00-11:45">11:00-11:45</option>
                                <option value="11:45-12:30">11:45-12:30</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف:</label>
                            <input type="tel" id="test-phone" placeholder="99887766" value="99887766">
                        </div>
                        <div class="form-group">
                            <label>القاعة:</label>
                            <select id="test-room">
                                <option value="room1">قاعة المختبر</option>
                                <option value="room2">قاعة الرياضيات</option>
                                <option value="room3">قاعة العلوم</option>
                                <option value="room4">قاعة اللغات</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="createTestReservation()">إنشاء الحجز</button>
                    <button onclick="createMultipleReservations()">إنشاء حجوزات متعددة</button>
                </div>
            </div>

            <!-- إحصائيات الحجوزات -->
            <div class="test-section">
                <h2>📊 إحصائيات الحجوزات</h2>
                <div class="stats-card">
                    <div class="stats-number" id="total-reservations">0</div>
                    <div>إجمالي الحجوزات</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="stats-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <div class="stats-number" id="today-reservations">0</div>
                        <div style="font-size: 12px;">حجوزات اليوم</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="stats-number" id="firebase-reservations">0</div>
                        <div style="font-size: 12px;">في Firebase</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- اختبارات المزامنة -->
        <div class="test-section full-width">
            <h2>🔄 اختبارات المزامنة المتقدمة</h2>
            <button onclick="testReservationSync()">مزامنة الحجوزات</button>
            <button onclick="testConflictResolution()">اختبار حل التعارضات</button>
            <button onclick="testDateTimeSync()">اختبار مزامنة التواريخ</button>
            <button onclick="testGradeSystemSync()">اختبار مزامنة الدرجات والأقسام</button>
            <button onclick="testBulkSync()">مزامنة مجموعة كبيرة</button>
            <button onclick="testOfflineMode()">اختبار وضع عدم الاتصال</button>
            <button onclick="clearReservations()">مسح جميع الحجوزات</button>
        </div>

        <!-- عرض الحجوزات -->
        <div class="test-section full-width">
            <h2>📋 الحجوزات الحالية</h2>
            <div id="reservations-display">
                <p style="text-align: center; color: #666;">لا توجد حجوزات حتى الآن</p>
            </div>
        </div>

        <!-- نتائج الاختبارات -->
        <div id="results"></div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // إعدادات Firebase
        window.FIREBASE_ENABLED = true;
        window.FIREBASE_READY = false;

        const firebaseConfig = {
            apiKey: "AIzaSyCddo_kfYs8wO_xzZgf2WsWDvBWW8wC8rE",
            authDomain: "zawiyah-76151.firebaseapp.com",
            projectId: "zawiyah-76151",
            storageBucket: "zawiyah-76151.appspot.com",
            messagingSenderId: "259480775839",
            appId: "1:259480775839:web:0a95d39bfeb45f4c3abd83"
        };

        try {
            if (window.FIREBASE_ENABLED && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
                window.FIREBASE_READY = true;
            }
        } catch (error) {
            console.warn('⚠️ فشل في تهيئة Firebase:', error);
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        function isFirebaseReady() {
            return window.FIREBASE_ENABLED && window.FIREBASE_READY && window.db;
        }

        function disableFirebase() {
            window.FIREBASE_ENABLED = false;
            window.FIREBASE_READY = false;
        }

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            
            results.innerHTML += `<div><span class="${className}">${time}: ${message}</span></div>`;
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function updateSyncStatus(status) {
            const indicator = document.querySelector('.sync-indicator');
            const statusText = document.getElementById('sync-status');
            
            if (status === 'active') {
                indicator.className = 'sync-indicator sync-active';
                statusText.innerHTML = '<span class="sync-indicator sync-active"></span>متصل ومتزامن';
            } else if (status === 'syncing') {
                indicator.className = 'sync-indicator sync-syncing';
                statusText.innerHTML = '<span class="sync-indicator sync-syncing"></span>جاري المزامنة...';
            } else {
                indicator.className = 'sync-indicator sync-inactive';
                statusText.innerHTML = '<span class="sync-indicator sync-inactive"></span>غير متصل - يعمل محلياً';
            }
        }
    </script>

    <!-- تحميل مدير البيانات -->
    <script src="dataManager.js"></script>
    <!-- تحميل نظام منع التعارضات -->
    <script src="conflictPrevention.js"></script>

    <script>
        let reservationIdCounter = 1;

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', async function() {
            // تعيين تاريخ اليوم
            document.getElementById('test-date').value = new Date().toISOString().split('T')[0];
            
            log('🔄 تهيئة صفحة اختبار الحجوزات المتقدمة...');
            
            // انتظار تهيئة مدير البيانات
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            updateStats();
            displayReservations();
            updateSyncStatus(isFirebaseReady() ? 'active' : 'inactive');
            
            // تحديث الإحصائيات كل 10 ثواني
            setInterval(() => {
                updateStats();
                displayReservations();
            }, 10000);
        });

        async function createTestReservation() {
            log('🔄 إنشاء حجز تجريبي...');
            updateSyncStatus('syncing');

            try {
                const reservation = {
                    id: 'reservation_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    subject: document.getElementById('test-subject').value,
                    teacher: document.getElementById('test-teacher').value,
                    grade: document.getElementById('test-grade').value,
                    section: document.getElementById('test-section').value,
                    date: document.getElementById('test-date').value,
                    time: document.getElementById('test-time').value,
                    phone: document.getElementById('test-phone').value,
                    room: document.getElementById('test-room').value,
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    // إضافة التاريخ الهجري
                    hijriDate: convertToHijri(new Date(document.getElementById('test-date').value)),
                    // معلومات إضافية للاختبار
                    testData: true,
                    syncAttempts: 0
                };

                // إضافة الحجز للنظام
                const reservations = await window.dataManager.getData('reservations');
                reservations.push(reservation);
                
                const success = await window.dataManager.saveData('reservations', reservations);
                
                if (success) {
                    log(`✅ تم إنشاء الحجز بنجاح: ${reservation.subject} - ${reservation.grade}${reservation.section}`, 'success');
                    updateStats();
                    displayReservations();
                    updateSyncStatus('active');
                } else {
                    log('❌ فشل في إنشاء الحجز', 'error');
                    updateSyncStatus('inactive');
                }
            } catch (error) {
                log(`❌ خطأ في إنشاء الحجز: ${error.message}`, 'error');
                updateSyncStatus('inactive');
            }
        }

        async function createMultipleReservations() {
            log('🔄 إنشاء حجوزات متعددة للاختبار...');
            updateSyncStatus('syncing');

            try {
                const subjects = ['الرياضيات', 'العلوم', 'اللغة العربية', 'اللغة الإنجليزية', 'الفيزياء'];
                const grades = ['10', '11', '12'];
                const sections = ['أ', 'ب', 'ج'];
                const times = ['07:30-08:15', '08:15-09:00', '09:00-09:45', '09:45-10:30'];
                
                const reservations = await window.dataManager.getData('reservations');
                
                for (let i = 0; i < 5; i++) {
                    const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
                    const randomGrade = grades[Math.floor(Math.random() * grades.length)];
                    const randomSection = sections[Math.floor(Math.random() * sections.length)];
                    const randomTime = times[Math.floor(Math.random() * times.length)];
                    
                    // تاريخ عشوائي في الأسبوع القادم
                    const randomDate = new Date();
                    randomDate.setDate(randomDate.getDate() + Math.floor(Math.random() * 7));
                    
                    const reservation = {
                        id: 'multi_reservation_' + Date.now() + '_' + i,
                        subject: randomSubject,
                        teacher: `أ. معلم ${i + 1}`,
                        grade: randomGrade,
                        section: randomSection,
                        date: randomDate.toISOString().split('T')[0],
                        time: randomTime,
                        phone: `9988${7700 + i}`,
                        room: `room${(i % 4) + 1}`,
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        hijriDate: convertToHijri(randomDate),
                        testData: true,
                        batchNumber: Math.floor(Date.now() / 1000)
                    };
                    
                    reservations.push(reservation);
                }
                
                const success = await window.dataManager.saveData('reservations', reservations);
                
                if (success) {
                    log('✅ تم إنشاء 5 حجوزات متعددة بنجاح', 'success');
                    updateStats();
                    displayReservations();
                    updateSyncStatus('active');
                } else {
                    log('❌ فشل في إنشاء الحجوزات المتعددة', 'error');
                    updateSyncStatus('inactive');
                }
            } catch (error) {
                log(`❌ خطأ في إنشاء الحجوزات المتعددة: ${error.message}`, 'error');
                updateSyncStatus('inactive');
            }
        }

        async function testReservationSync() {
            log('🔄 اختبار مزامنة الحجوزات مع Firebase...');
            updateSyncStatus('syncing');
            
            if (!isFirebaseReady()) {
                log('⚠️ Firebase غير متاح للمزامنة', 'warning');
                updateSyncStatus('inactive');
                return;
            }

            try {
                const reservations = await window.dataManager.getData('reservations');
                
                // رفع البيانات لـ Firebase
                const success = await window.dataManager.saveToFirebase('reservations', reservations);
                
                if (success) {
                    log('✅ تمت مزامنة جميع الحجوزات مع Firebase بنجاح', 'success');
                    
                    // التحقق من صحة المزامنة
                    const firebaseData = await window.dataManager.getFromFirebase('reservations');
                    log(`📊 تم التحقق: ${firebaseData.length} حجز في Firebase`, 'info');
                    
                    updateSyncStatus('active');
                } else {
                    log('❌ فشل في مزامنة الحجوزات مع Firebase', 'error');
                    updateSyncStatus('inactive');
                }
            } catch (error) {
                log(`❌ خطأ في مزامنة الحجوزات: ${error.message}`, 'error');
                updateSyncStatus('inactive');
            }
        }

        async function testConflictResolution() {
            log('🔄 اختبار حل تعارضات الحجوزات...');
            
            try {
                // إنشاء حجز محلي
                const localReservations = await window.dataManager.getData('reservations');
                const conflictId = 'conflict_test_' + Date.now();
                
                const localReservation = {
                    id: conflictId,
                    subject: 'مادة محلية',
                    teacher: 'أ. محلي',
                    grade: '10',
                    section: 'أ',
                    date: new Date().toISOString().split('T')[0],
                    time: '08:15-09:00',
                    phone: '11223344',
                    room: 'room1',
                    lastModified: new Date().toISOString(),
                    testConflict: 'local'
                };
                
                localReservations.push(localReservation);
                await window.dataManager.saveToLocalStorage('reservations', localReservations);
                log('✅ تم إنشاء حجز محلي متعارض', 'success');
                
                // إنشاء حجز مختلف في Firebase
                if (isFirebaseReady()) {
                    const firebaseReservations = [...localReservations];
                    const firebaseIndex = firebaseReservations.findIndex(r => r.id === conflictId);
                    
                    if (firebaseIndex !== -1) {
                        firebaseReservations[firebaseIndex] = {
                            ...firebaseReservations[firebaseIndex],
                            subject: 'مادة Firebase',
                            teacher: 'أ. Firebase',
                            testConflict: 'firebase',
                            lastModified: new Date(Date.now() + 1000).toISOString() // أحدث بثانية واحدة
                        };
                    }
                    
                    await window.dataManager.saveToFirebase('reservations', firebaseReservations);
                    log('✅ تم إنشاء حجز Firebase متعارض', 'success');
                    
                    // تشغيل حل التعارضات
                    await window.dataManager.syncDataInBackground('reservations');
                    log('✅ تم تشغيل آلية حل التعارضات', 'success');
                    
                    displayReservations();
                }
            } catch (error) {
                log(`❌ خطأ في اختبار حل التعارضات: ${error.message}`, 'error');
            }
        }

        async function testDateTimeSync() {
            log('🔄 اختبار مزامنة التواريخ (ميلادي + هجري)...');
            
            try {
                const reservations = await window.dataManager.getData('reservations');
                
                // فلترة الحجوزات التي تحتوي على تواريخ هجرية
                const hijriReservations = reservations.filter(r => r.hijriDate);
                log(`📅 تم العثور على ${hijriReservations.length} حجز يحتوي على تاريخ هجري`, 'info');
                
                // التحقق من صحة تحويل التواريخ
                hijriReservations.forEach(reservation => {
                    const gregorianDate = new Date(reservation.date);
                    log(`📆 ${reservation.subject}: ميلادي ${reservation.date} = هجري ${reservation.hijriDate}`, 'info');
                });
                
                // مزامنة مع Firebase
                if (isFirebaseReady()) {
                    await window.dataManager.saveToFirebase('reservations', reservations);
                    log('✅ تمت مزامنة التواريخ مع Firebase بنجاح', 'success');
                }
                
            } catch (error) {
                log(`❌ خطأ في مزامنة التواريخ: ${error.message}`, 'error');
            }
        }

        async function testGradeSystemSync() {
            log('🔄 اختبار مزامنة نظام الدرجات والأقسام...');
            
            try {
                const reservations = await window.dataManager.getData('reservations');
                
                // إحصائيات الدرجات
                const gradeStats = {};
                const sectionStats = {};
                
                reservations.forEach(reservation => {
                    // إحصائيات الدرجات
                    if (!gradeStats[reservation.grade]) {
                        gradeStats[reservation.grade] = 0;
                    }
                    gradeStats[reservation.grade]++;
                    
                    // إحصائيات الأقسام
                    if (!sectionStats[reservation.section]) {
                        sectionStats[reservation.section] = 0;
                    }
                    sectionStats[reservation.section]++;
                });
                
                log('📊 إحصائيات الدرجات:', 'info');
                Object.entries(gradeStats).forEach(([grade, count]) => {
                    log(`   الصف ${grade}: ${count} حجز`, 'info');
                });
                
                log('📊 إحصائيات الأقسام:', 'info');
                Object.entries(sectionStats).forEach(([section, count]) => {
                    log(`   القسم ${section}: ${count} حجز`, 'info');
                });
                
                // التحقق من صحة نظام الأقسام (5-10: 3 أقسام، 11-12: 6 أقسام)
                const invalidSections = reservations.filter(r => {
                    const grade = parseInt(r.grade);
                    const section = r.section;
                    
                    if (grade >= 5 && grade <= 10) {
                        return !['أ', 'ب', 'ج'].includes(section);
                    } else if (grade >= 11 && grade <= 12) {
                        return !['أ', 'ب', 'ج', 'د', 'ه', 'و'].includes(section);
                    }
                    return false;
                });
                
                if (invalidSections.length > 0) {
                    log(`⚠️ تم العثور على ${invalidSections.length} حجز بأقسام غير صحيحة`, 'warning');
                } else {
                    log('✅ جميع الأقسام صحيحة حسب نظام المدرسة', 'success');
                }
                
            } catch (error) {
                log(`❌ خطأ في اختبار نظام الدرجات: ${error.message}`, 'error');
            }
        }

        async function testBulkSync() {
            log('🔄 اختبار مزامنة مجموعة كبيرة من الحجوزات...');
            updateSyncStatus('syncing');
            
            try {
                // إنشاء 20 حجز تجريبي
                const reservations = await window.dataManager.getData('reservations');
                const startCount = reservations.length;
                
                for (let i = 0; i < 20; i++) {
                    const bulkReservation = {
                        id: 'bulk_' + Date.now() + '_' + i,
                        subject: `مادة مجمعة ${i + 1}`,
                        teacher: `أ. مجمع ${i + 1}`,
                        grade: String(Math.floor(Math.random() * 8) + 5), // 5-12
                        section: ['أ', 'ب', 'ج'][Math.floor(Math.random() * 3)],
                        date: new Date(Date.now() + (i * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                        time: '08:15-09:00',
                        phone: `998877${String(i).padStart(2, '0')}`,
                        room: `room${(i % 4) + 1}`,
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        bulkTest: true
                    };
                    
                    reservations.push(bulkReservation);
                }
                
                // حفظ محلياً
                await window.dataManager.saveData('reservations', reservations);
                log(`✅ تم إنشاء ${reservations.length - startCount} حجز إضافي محلياً`, 'success');
                
                // مزامنة مع Firebase
                if (isFirebaseReady()) {
                    const syncSuccess = await window.dataManager.saveToFirebase('reservations', reservations);
                    if (syncSuccess) {
                        log('✅ تمت مزامنة المجموعة الكبيرة مع Firebase بنجاح', 'success');
                        updateSyncStatus('active');
                    } else {
                        log('❌ فشل في مزامنة المجموعة الكبيرة', 'error');
                        updateSyncStatus('inactive');
                    }
                }
                
                updateStats();
                displayReservations();
                
            } catch (error) {
                log(`❌ خطأ في مزامنة المجموعة الكبيرة: ${error.message}`, 'error');
                updateSyncStatus('inactive');
            }
        }

        async function testOfflineMode() {
            log('🔄 اختبار وضع عدم الاتصال...');
            
            // إيقاف Firebase مؤقتاً
            const wasEnabled = window.FIREBASE_ENABLED;
            disableFirebase();
            if (window.dataManager) {
                window.dataManager.disableFirebase();
            }
            updateSyncStatus('inactive');
            log('⚠️ تم إيقاف Firebase - اختبار الوضع المحلي', 'warning');
            
            try {
                // إنشاء حجز في وضع عدم الاتصال
                const offlineReservation = {
                    id: 'offline_test_' + Date.now(),
                    subject: 'حجز بدون اتصال',
                    teacher: 'أ. محلي',
                    grade: '11',
                    section: 'ب',
                    date: new Date().toISOString().split('T')[0],
                    time: '09:00-09:45',
                    phone: '99887744',
                    room: 'room2',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    offlineCreated: true
                };
                
                const reservations = await window.dataManager.getData('reservations');
                reservations.push(offlineReservation);
                await window.dataManager.saveData('reservations', reservations);
                
                log('✅ تم إنشاء حجز بنجاح في وضع عدم الاتصال', 'success');
                
                // إعادة تفعيل Firebase بعد 3 ثواني
                setTimeout(async () => {
                    window.FIREBASE_ENABLED = wasEnabled;
                    if (window.db && wasEnabled) {
                        window.FIREBASE_READY = true;
                        if (window.dataManager) {
                            window.dataManager.checkFirebaseAvailability();
                        }
                    }
                    
                    updateSyncStatus('active');
                    log('✅ تم إعادة تفعيل Firebase', 'success');
                    
                    // محاولة مزامنة البيانات المحلية
                    if (isFirebaseReady()) {
                        const syncSuccess = await window.dataManager.forceSyncAll();
                        if (syncSuccess) {
                            log('✅ تمت مزامنة البيانات المحلية مع Firebase بنجاح', 'success');
                        }
                    }
                    
                    updateStats();
                    displayReservations();
                }, 3000);
                
            } catch (error) {
                log(`❌ خطأ في اختبار وضع عدم الاتصال: ${error.message}`, 'error');
            }
        }

        async function clearReservations() {
            if (!confirm('هل أنت متأكد من مسح جميع الحجوزات؟')) return;
            
            log('🔄 مسح جميع الحجوزات...');
            
            try {
                await window.dataManager.saveData('reservations', []);
                
                if (isFirebaseReady()) {
                    await window.dataManager.saveToFirebase('reservations', []);
                }
                
                log('✅ تم مسح جميع الحجوزات بنجاح', 'success');
                updateStats();
                displayReservations();
            } catch (error) {
                log(`❌ خطأ في مسح الحجوزات: ${error.message}`, 'error');
            }
        }

        async function updateStats() {
            try {
                const reservations = await window.dataManager.getData('reservations');
                
                // إجمالي الحجوزات
                document.getElementById('total-reservations').textContent = reservations.length;
                
                // حجوزات اليوم
                const today = new Date().toISOString().split('T')[0];
                const todayReservations = reservations.filter(r => r.date === today);
                document.getElementById('today-reservations').textContent = todayReservations.length;
                
                // حجوزات Firebase (إذا كان متاح)
                if (isFirebaseReady()) {
                    try {
                        const firebaseReservations = await window.dataManager.getFromFirebase('reservations');
                        document.getElementById('firebase-reservations').textContent = firebaseReservations.length;
                    } catch (error) {
                        document.getElementById('firebase-reservations').textContent = 'خطأ';
                    }
                } else {
                    document.getElementById('firebase-reservations').textContent = 'غير متاح';
                }
                
            } catch (error) {
                console.error('خطأ في تحديث الإحصائيات:', error);
            }
        }

        async function displayReservations() {
            try {
                const reservations = await window.dataManager.getData('reservations');
                const displayDiv = document.getElementById('reservations-display');
                
                if (reservations.length === 0) {
                    displayDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد حجوزات حتى الآن</p>';
                    return;
                }
                
                // ترتيب الحجوزات حسب التاريخ والوقت
                reservations.sort((a, b) => {
                    if (a.date !== b.date) {
                        return new Date(a.date) - new Date(b.date);
                    }
                    return a.time.localeCompare(b.time);
                });
                
                let html = '';
                reservations.forEach((reservation, index) => {
                    html += `
                        <div class="reservation-card">
                            <div class="reservation-header">
                                <div class="reservation-title">${reservation.subject}</div>
                                <div class="reservation-date">${reservation.date}</div>
                            </div>
                            <div class="reservation-details">
                                <div class="detail-item">
                                    <span class="detail-label">المعلم</span>
                                    ${reservation.teacher}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">الصف والقسم</span>
                                    ${reservation.grade}${reservation.section}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">الوقت</span>
                                    ${reservation.time}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">القاعة</span>
                                    ${reservation.room}
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">الهاتف</span>
                                    ${reservation.phone}
                                </div>
                                ${reservation.hijriDate ? `
                                <div class="detail-item">
                                    <span class="detail-label">التاريخ الهجري</span>
                                    ${reservation.hijriDate}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                displayDiv.innerHTML = html;
                
            } catch (error) {
                console.error('خطأ في عرض الحجوزات:', error);
                document.getElementById('reservations-display').innerHTML = 
                    '<p style="color: red;">خطأ في تحميل الحجوزات</p>';
            }
        }

        // دالة تحويل بسيطة للتاريخ الهجري (تقريبية)
        function convertToHijri(gregorianDate) {
            // هذه دالة تقريبية - في التطبيق الحقيقي يفضل استخدام مكتبة متخصصة
            const hijriYear = Math.floor(((gregorianDate.getFullYear() - 622) * 365.25) / 354.37) + 1;
            const hijriMonth = Math.floor(Math.random() * 12) + 1; // تقريبي للاختبار
            const hijriDay = Math.floor(Math.random() * 29) + 1; // تقريبي للاختبار
            
            const monthNames = [
                'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
                'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
            ];
            
            return `${hijriDay} ${monthNames[hijriMonth - 1]} ${hijriYear}هـ`;
        }
    </script>
</body>
</html>